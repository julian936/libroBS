# Visualización de las Series de Tiempo {#intro}

Las visualizaciones tienen como objetivo explorar y comunicar los patrones, tendencias y comportamientos presentes en las series de tiempo de precios de acciones durante el período 2015-2025, con énfasis en el impacto del COVID-19.

```{r setup-viz, include=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(scales)
library(gridExtra)

# Cargar plotly solo si el output es HTML
is_html_output <- function() {
  knitr::opts_knit$get("rmarkdown.pandoc.to") %in% c("html", "html4", "html5")
}

if(is_html_output()) {
  library(plotly)
}

# Cargar datos
datos_completos <- read_xlsx("datos_yahoo/datasets/datos_completos.xlsx") %>%
  mutate(Fecha = as.Date(Fecha))

# Colores por ticker
colores_tickers <- c(
  "AAPL" = "#007AFF", "MSFT" = "#34C759", "TSLA" = "#FF3B30",
  "PFE" = "#AF52DE", "MRNA" = "#FF9500", "JNJ" = "#E91E63"
)
```

## Series de Tiempo Completas

Los siguientes gráficos proporcionan una visión general de la evolución de los precios de cada activo a lo largo del período 2015-2025.

### Sector Tecnológico

```{r series-tech, warning=FALSE, message=FALSE, echo=FALSE, fig.height=7, fig.cap="Series de tiempo del sector tecnológico. Se observa el crecimiento explosivo de Tesla post-2019, la estabilidad relativa de Apple y Microsoft, y el impacto del COVID-19 (área sombreada) en las tres empresas."}
datos_tech <- datos_completos %>% filter(Sector == "Tecnología")

if(is_html_output()) {
  # VERSION INTERACTIVA CON PLOTLY
  fig_tech <- plot_ly(height = 500)  # ✅ CAMBIO 1: height aquí (reducido de 600 a 500)
  
  # Agregar área COVID
  fig_tech <- fig_tech %>%
    add_trace(
      x = c(as.Date("2020-01-01"), as.Date("2022-01-01"), 
            as.Date("2022-01-01"), as.Date("2020-01-01")),
      y = c(0, 0, 600, 600),
      type = "scatter",
      mode = "lines",
      fill = "toself",
      fillcolor = "rgba(231, 76, 60, 0.1)",
      line = list(color = "transparent"),
      showlegend = FALSE,
      hoverinfo = "text",
      text = "Período COVID-19",
      name = "COVID-19"
    )
  
  # Agregar líneas por empresa
  for(ticker in c("AAPL", "MSFT", "TSLA")) {
    df <- datos_tech %>% filter(Ticker == ticker)
    
    fig_tech <- fig_tech %>%
      add_trace(
        data = df,
        x = ~Fecha,
        y = ~Close,
        type = "scatter",
        mode = "lines",
        name = paste(ticker, "- Tecnología"),
        line = list(color = colores_tickers[ticker], width = 2),
        hovertemplate = paste(
          "<b>%{fullData.name}</b><br>",
          "Fecha: %{x|%Y-%m-%d}<br>",
          "Precio: $%{y:,.2f}<br>",
          "<extra></extra>"
        )
      )
  }
  
  fig_tech <- fig_tech %>%
    layout(
      title = "Series de Tiempo del Sector Tecnológico (2015-2025)",
      xaxis = list(title = ""),
      yaxis = list(title = "Precio ($)", tickformat = "$,.0f"),
      hovermode = "x unified",
      legend = list(x = 0.01, y = 0.99)
      # ✅ CAMBIO 2: height eliminado de aquí
    )
  
  fig_tech
  
} else {
  # VERSION ESTATICA CON GGPLOT PARA PDF
  plots_tech <- list()
  for(ticker in c("AAPL", "MSFT", "TSLA")) {
    df <- datos_tech %>% filter(Ticker == ticker)
    
    p <- ggplot(df, aes(x = Fecha, y = Close)) +
      geom_rect(aes(xmin = as.Date("2020-01-01"), xmax = as.Date("2022-01-01"),
                    ymin = -Inf, ymax = Inf),
                fill = "#E74C3C", alpha = 0.05) +
      geom_line(color = colores_tickers[ticker], linewidth = 0.7) +
      labs(title = paste(ticker, "- Tecnología"),
           x = NULL, y = "Precio ($)") +
      theme_minimal(base_size = 10) +
      scale_y_continuous(labels = dollar_format())
    
    plots_tech[[ticker]] <- p
  }
  
  do.call(grid.arrange, c(plots_tech, ncol = 1))
}
```

**Observaciones clave del sector tecnológico:**

- **Apple (AAPL):** Muestra un crecimiento sostenido de $22.58 a $259.02 (+778%), con volatilidad moderada (29.2% anual). Durante el COVID-19, experimentó una caída breve seguida de recuperación acelerada.

- **Microsoft (MSFT):** Presenta el comportamiento más estable del sector con crecimiento constante de $46.68 a $535.64 (+990%). La volatilidad de 27% anual es la más baja del sector tecnológico. Mínima afectación durante el crash de marzo 2020.

- **Tesla (TSLA):** Exhibe el comportamiento más volátil (59.3% anual) y el mayor retorno (+2,729%). Se observa crecimiento casi exponencial desde 2019, con alta sensibilidad a eventos de mercado.

### Sector Farmacéutico

```{r series-pharma, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.cap="Series de tiempo del sector farmacéutico. Destaca el pico dramático de Moderna durante el período de vacunas (2020-2021), mientras que Pfizer y J&J muestran comportamientos más estables."}
datos_pharma <- datos_completos %>% filter(Sector == "Farmacéutica")

if(is_html_output()) {
  # VERSION INTERACTIVA CON PLOTLY
  fig_pharma <- plot_ly(height = 600)
  
  # Agregar área COVID
  fig_pharma <- fig_pharma %>%
    add_trace(
      x = c(as.Date("2020-01-01"), as.Date("2022-01-01"), 
            as.Date("2022-01-01"), as.Date("2020-01-01")),
      y = c(0, 0, 550, 550),
      type = "scatter",
      mode = "lines",
      fill = "toself",
      fillcolor = "rgba(231, 76, 60, 0.1)",
      line = list(color = "transparent"),
      showlegend = FALSE,
      hoverinfo = "text",
      text = "Período COVID-19",
      name = "COVID-19"
    )
  
  # Agregar área vacunas
  fig_pharma <- fig_pharma %>%
    add_trace(
      x = c(as.Date("2020-12-01"), as.Date("2022-01-01"), 
            as.Date("2022-01-01"), as.Date("2020-12-01")),
      y = c(0, 0, 550, 550),
      type = "scatter",
      mode = "lines",
      fill = "toself",
      fillcolor = "rgba(39, 174, 96, 0.1)",
      line = list(color = "transparent"),
      showlegend = FALSE,
      hoverinfo = "text",
      text = "Período de Vacunas",
      name = "Vacunas"
    )
  
  # Agregar líneas por empresa
  for(ticker in c("PFE", "MRNA", "JNJ")) {
    df <- datos_pharma %>% filter(Ticker == ticker)
    
    fig_pharma <- fig_pharma %>%
      add_trace(
        data = df,
        x = ~Fecha,
        y = ~Close,
        type = "scatter",
        mode = "lines",
        name = paste(ticker, "- Farmacéutica"),
        line = list(color = colores_tickers[ticker], width = 2),
        hovertemplate = paste(
          "<b>%{fullData.name}</b><br>",
          "Fecha: %{x|%Y-%m-%d}<br>",
          "Precio: $%{y:,.2f}<br>",
          "<extra></extra>"
        )
      )
  }
  
  fig_pharma <- fig_pharma %>%
    layout(
      title = "Series de Tiempo del Sector Farmacéutico (2015-2025)",
      xaxis = list(title = ""),
      yaxis = list(title = "Precio ($)", tickformat = "$,.0f"),
      hovermode = "x unified",
      legend = list(x = 0.01, y = 0.99)
    )
  
  fig_pharma
  
} else {
  # VERSION ESTATICA CON GGPLOT PARA PDF
  plots_pharma <- list()
  for(ticker in c("PFE", "MRNA", "JNJ")) {
    df <- datos_pharma %>% filter(Ticker == ticker)
    
    p <- ggplot(df, aes(x = Fecha, y = Close)) +
      geom_rect(aes(xmin = as.Date("2020-01-01"), xmax = as.Date("2022-01-01"),
                    ymin = -Inf, ymax = Inf),
                fill = "#E74C3C", alpha = 0.05) +
      geom_rect(aes(xmin = as.Date("2020-12-01"), xmax = as.Date("2022-01-01"),
                    ymin = -Inf, ymax = Inf),
                fill = "#27AE60", alpha = 0.05) +
      geom_line(color = colores_tickers[ticker], linewidth = 0.7) +
      labs(title = paste(ticker, "- Farmacéutica"),
           x = NULL, y = "Precio ($)") +
      theme_minimal(base_size = 10) +
      scale_y_continuous(labels = dollar_format())
    
    plots_pharma[[ticker]] <- p
  }
  
  do.call(grid.arrange, c(plots_pharma, ncol = 1))
}
```

**Observaciones clave del sector farmacéutico:**

- **Pfizer (PFE):** Comportamiento estable con retorno negativo (-20.8%). Volatilidad moderada (24% anual). Pico durante el anuncio y distribución de vacunas, seguido de corrección.

- **Moderna (MRNA):** La mayor volatilidad del dataset (72.1% anual). Crecimiento explosivo durante el desarrollo de vacunas (diciembre 2020), alcanzando $484.47 desde $12.26. Posterior corrección drástica reflejando la normalización post-pandemia.

- **Johnson & Johnson (JNJ):** La menor volatilidad de todo el dataset (18.4% anual). Comportamiento defensivo con retorno total de +99.8%. Mínima afectación durante COVID-19.

## Análisis con Promedios Móviles

Los promedios móviles permiten suavizar la volatilidad diaria y visualizar tendencias subyacentes. Se calculan promedios de 7, 30 y 90 días.

```{r promedio-movil-function, echo=FALSE}
calcular_sma <- function(datos, ventana) {
  datos %>%
    group_by(Ticker) %>%
    arrange(Fecha) %>%
    mutate(SMA = zoo::rollmean(Close, k = ventana, fill = NA, align = "right")) %>%
    ungroup()
}
```

### Promedios Móviles - Tecnología

```{r sma-tech, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.cap="Series con promedios móviles del sector tecnológico. Las líneas suavizadas (SMA 7, 30, 90 días) revelan las tendencias subyacentes y confirman el crecimiento sostenido post-COVID."}
datos_sma_tech <- datos_tech

for(ventana in c(7, 30, 90)) {
  datos_sma_tech <- calcular_sma(datos_sma_tech, ventana)
  names(datos_sma_tech)[names(datos_sma_tech) == "SMA"] <- paste0("SMA_", ventana)
}

for(ticker in c("AAPL", "MSFT", "TSLA")) {
  df <- datos_sma_tech %>% filter(Ticker == ticker)
  
  if(is_html_output()) {
    # VERSION PLOTLY
    fig <- plot_ly(df, height = 500)  # ALTURA AQUI
    
    fig <- fig %>%
      add_trace(x = ~Fecha, y = ~Close, type = "scatter", mode = "lines",
                name = "Precio Diario",
                line = list(color = "rgba(128, 128, 128, 0.3)", width = 1)) %>%
      add_trace(x = ~Fecha, y = ~SMA_7, type = "scatter", mode = "lines",
                name = "SMA 7 días",
                line = list(color = "#E74C3C", width = 2)) %>%
      add_trace(x = ~Fecha, y = ~SMA_30, type = "scatter", mode = "lines",
                name = "SMA 30 días",
                line = list(color = "#F39C12", width = 2)) %>%
      add_trace(x = ~Fecha, y = ~SMA_90, type = "scatter", mode = "lines",
                name = "SMA 90 días",
                line = list(color = "#27AE60", width = 2)) %>%
      layout(title = paste(ticker, "- Promedios Móviles"),
             xaxis = list(title = ""),
             yaxis = list(title = "Precio ($)", tickformat = "$,.0f"),
             hovermode = "x unified")  # SIN HEIGHT AQUI
    
    print(fig)
    
  } else {
    # VERSION GGPLOT
    p <- ggplot(df, aes(x = Fecha)) +
      geom_line(aes(y = Close), color = "gray70", alpha = 0.5, linewidth = 0.3) +
      geom_line(aes(y = SMA_7, color = "7 días"), linewidth = 0.8) +
      geom_line(aes(y = SMA_30, color = "30 días"), linewidth = 0.8) +
      geom_line(aes(y = SMA_90, color = "90 días"), linewidth = 0.8) +
      scale_color_manual(values = c("7 días" = "#E74C3C", 
                                     "30 días" = "#F39C12", 
                                     "90 días" = "#27AE60")) +
      labs(title = paste(ticker, "- Promedios Móviles"),
           x = NULL, y = "Precio ($)", color = "Promedio") +
      theme_minimal(base_size = 10) +
      theme(legend.position = "bottom")
    
    print(p)
  }
}
```

**Interpretación de promedios móviles:**

- **SMA 7 días:** Reacciona rápidamente a cambios, útil para identificar reversiones de corto plazo.
- **SMA 30 días:** Revela tendencias de mediano plazo, filtrando ruido diario.
- **SMA 90 días:** Muestra la tendencia de largo plazo, especialmente útil para identificar cambios de régimen durante COVID-19.

### Promedios Móviles - Farmacéuticas

```{r sma-pharma, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.cap="Series con promedios móviles del sector farmacéutico. El caso de Moderna es particularmente interesante, mostrando cómo los promedios capturan el ciclo completo de auge y corrección."}
datos_sma_pharma <- datos_pharma

for(ventana in c(7, 30, 90)) {
  datos_sma_pharma <- calcular_sma(datos_sma_pharma, ventana)
  names(datos_sma_pharma)[names(datos_sma_pharma) == "SMA"] <- paste0("SMA_", ventana)
}

for(ticker in c("PFE", "MRNA", "JNJ")) {
  df <- datos_sma_pharma %>% filter(Ticker == ticker)
  
  if(is_html_output()) {
    # VERSION PLOTLY
    fig <- plot_ly(df, height = 500)  # ALTURA AQUI
    
    fig <- fig %>%
      add_trace(x = ~Fecha, y = ~Close, type = "scatter", mode = "lines",
                name = "Precio Diario",
                line = list(color = "rgba(128, 128, 128, 0.3)", width = 1)) %>%
      add_trace(x = ~Fecha, y = ~SMA_7, type = "scatter", mode = "lines",
                name = "SMA 7 días",
                line = list(color = "#E74C3C", width = 2)) %>%
      add_trace(x = ~Fecha, y = ~SMA_30, type = "scatter", mode = "lines",
                name = "SMA 30 días",
                line = list(color = "#F39C12", width = 2)) %>%
      add_trace(x = ~Fecha, y = ~SMA_90, type = "scatter", mode = "lines",
                name = "SMA 90 días",
                line = list(color = "#27AE60", width = 2)) %>%
      layout(title = paste(ticker, "- Promedios Móviles"),
             xaxis = list(title = ""),
             yaxis = list(title = "Precio ($)", tickformat = "$,.0f"),
             hovermode = "x unified")  # SIN HEIGHT AQUI
    
    print(fig)
    
  } else {
    # VERSION GGPLOT
    p <- ggplot(df, aes(x = Fecha)) +
      geom_line(aes(y = Close), color = "gray70", alpha = 0.5, linewidth = 0.3) +
      geom_line(aes(y = SMA_7, color = "7 días"), linewidth = 0.8) +
      geom_line(aes(y = SMA_30, color = "30 días"), linewidth = 0.8) +
      geom_line(aes(y = SMA_90, color = "90 días"), linewidth = 0.8) +
      scale_color_manual(values = c("7 días" = "#E74C3C", 
                                     "30 días" = "#F39C12", 
                                     "90 días" = "#27AE60")) +
      labs(title = paste(ticker, "- Promedios Móviles"),
           x = NULL, y = "Precio ($)", color = "Promedio") +
      theme_minimal(base_size = 10) +
      theme(legend.position = "bottom")
    
    print(p)
  }
}
```
## Análisis de Rezagos

Los gráficos de rezago permiten identificar dependencia temporal en las series, evaluando si el precio de hoy está correlacionado con el precio de días anteriores.

### Rezagos - Apple (AAPL)

```{r lag-plots-aapl, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Gráficos de rezago para Apple. Lag 1 y lag 7 días muestran autocorrelación positiva moderada."}

if(is_html_output()) {
  crear_lag_plot_plotly <- function(datos, lag_days, ticker_sel) {
    df <- datos %>%
      filter(Ticker == ticker_sel) %>%
      arrange(Fecha) %>%
      mutate(Close_Lag = lag(Close, lag_days)) %>%
      filter(!is.na(Close_Lag))
    
    max_val <- max(c(df$Close, df$Close_Lag), na.rm = TRUE)
    min_val <- min(c(df$Close, df$Close_Lag), na.rm = TRUE)
    
    fig <- plot_ly(height = 400) %>%
      add_trace(
        data = df,
        x = ~Close_Lag, 
        y = ~Close,
        type = "scatter",
        mode = "markers",
        marker = list(color = colores_tickers[ticker_sel], size = 5, opacity = 0.6),
        hovertemplate = paste0(
          "<b>", ticker_sel, "</b><br>",
          "Precio (t-", lag_days, "): $%{x:,.2f}<br>",
          "Precio (t): $%{y:,.2f}<br>",
          "<extra></extra>"
        ),
        showlegend = FALSE
      ) %>%
      add_trace(
        x = c(min_val, max_val),
        y = c(min_val, max_val),
        type = "scatter",
        mode = "lines",
        line = list(dash = "dash", color = "red", width = 2),
        showlegend = FALSE,
        hoverinfo = "skip"
      ) %>%
      layout(
        title = list(text = paste(ticker_sel, "- Rezago", lag_days, "día(s)"), font = list(size = 14)),
        xaxis = list(title = paste("Precio (t -", lag_days, ")"), tickformat = "$,.0f"),
        yaxis = list(title = "Precio (t)", tickformat = "$,.0f")
      )
    return(fig)
  }
  
  p1 <- crear_lag_plot_plotly(datos_completos, 1, "AAPL")
  p2 <- crear_lag_plot_plotly(datos_completos, 7, "AAPL")
  
  plotly::subplot(p1, p2, nrows = 1, margin = 0.08) %>%
    layout(showlegend = FALSE, title = list(text = "Apple (AAPL) - Análisis de Rezagos", font = list(size = 16)))
  
} else {
  crear_lag_plot <- function(datos, lag_days, ticker_sel) {
    df <- datos %>%
      filter(Ticker == ticker_sel) %>%
      arrange(Fecha) %>%
      mutate(Close_Lag = lag(Close, lag_days))
    
    ggplot(df, aes(x = Close_Lag, y = Close)) +
      geom_point(color = colores_tickers[ticker_sel], alpha = 0.5, size = 1.5) +
      geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
      labs(title = paste(ticker_sel, "- Rezago", lag_days, "día(s)"),
           x = paste("Precio (t -", lag_days, ")"), y = "Precio (t)") +
      theme_minimal(base_size = 10) +
      scale_x_continuous(labels = dollar_format()) +
      scale_y_continuous(labels = dollar_format())
  }
  
  p1 <- crear_lag_plot(datos_completos, 1, "AAPL")
  p2 <- crear_lag_plot(datos_completos, 7, "AAPL")
  grid.arrange(p1, p2, ncol = 2)
}
```

**Interpretación Apple (AAPL):**

- **Lag 1**: Concentración fuerte de puntos a lo largo de la diagonal, indicando alta persistencia de precios día a día. La autocorrelación positiva es clara - si el precio fue alto ayer, es probable que sea alto hoy. Patrón lineal muy definido con poca dispersión, reflejo de la relativa estabilidad de Apple.

- **Lag 7**: Mantiene la concentración en la diagonal pero con ligera mayor dispersión que lag 1. Los precios de hace una semana aún tienen poder predictivo moderado sobre los precios actuales, aunque debilitado. La relación lineal se preserva, consistente con la baja volatilidad histórica de AAPL (29.2% anual).

### Rezagos - Tesla (TSLA)

```{r lag-plots-tsla, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Gráficos de rezago para Tesla. Mayor dispersión debido a alta volatilidad."}

if(is_html_output()) {
  crear_lag_plot_plotly <- function(datos, lag_days, ticker_sel) {
    df <- datos %>%
      filter(Ticker == ticker_sel) %>%
      arrange(Fecha) %>%
      mutate(Close_Lag = lag(Close, lag_days)) %>%
      filter(!is.na(Close_Lag))
    
    max_val <- max(c(df$Close, df$Close_Lag), na.rm = TRUE)
    min_val <- min(c(df$Close, df$Close_Lag), na.rm = TRUE)
    
    fig <- plot_ly(height = 400) %>%
      add_trace(
        data = df,
        x = ~Close_Lag, 
        y = ~Close,
        type = "scatter",
        mode = "markers",
        marker = list(color = colores_tickers[ticker_sel], size = 5, opacity = 0.6),
        hovertemplate = paste0(
          "<b>", ticker_sel, "</b><br>",
          "Precio (t-", lag_days, "): $%{x:,.2f}<br>",
          "Precio (t): $%{y:,.2f}<br>",
          "<extra></extra>"
        ),
        showlegend = FALSE
      ) %>%
      add_trace(
        x = c(min_val, max_val),
        y = c(min_val, max_val),
        type = "scatter",
        mode = "lines",
        line = list(dash = "dash", color = "red", width = 2),
        showlegend = FALSE,
        hoverinfo = "skip"
      ) %>%
      layout(
        title = list(text = paste(ticker_sel, "- Rezago", lag_days, "día(s)"), font = list(size = 14)),
        xaxis = list(title = paste("Precio (t -", lag_days, ")"), tickformat = "$,.0f"),
        yaxis = list(title = "Precio (t)", tickformat = "$,.0f")
      )
    return(fig)
  }
  
  p1 <- crear_lag_plot_plotly(datos_completos, 1, "TSLA")
  p2 <- crear_lag_plot_plotly(datos_completos, 7, "TSLA")
  
  plotly::subplot(p1, p2, nrows = 1, margin = 0.08) %>%
    layout(showlegend = FALSE, title = list(text = "Tesla (TSLA) - Análisis de Rezagos", font = list(size = 16)))
  
} else {
  crear_lag_plot <- function(datos, lag_days, ticker_sel) {
    df <- datos %>%
      filter(Ticker == ticker_sel) %>%
      arrange(Fecha) %>%
      mutate(Close_Lag = lag(Close, lag_days))
    
    ggplot(df, aes(x = Close_Lag, y = Close)) +
      geom_point(color = colores_tickers[ticker_sel], alpha = 0.5, size = 1.5) +
      geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
      labs(title = paste(ticker_sel, "- Rezago", lag_days, "día(s)"),
           x = paste("Precio (t -", lag_days, ")"), y = "Precio (t)") +
      theme_minimal(base_size = 10) +
      scale_x_continuous(labels = dollar_format()) +
      scale_y_continuous(labels = dollar_format())
  }
  
  p1 <- crear_lag_plot(datos_completos, 1, "TSLA")
  p2 <- crear_lag_plot(datos_completos, 7, "TSLA")
  grid.arrange(p1, p2, ncol = 2)
}
```

**Interpretación Tesla (TSLA):**

- **Lag 1**: Aunque sigue la diagonal, presenta notablemente mayor dispersión que Apple. Se observan clusters de alta densidad en diferentes rangos de precio (especialmente en niveles bajos ~$20-50 y altos ~$300-400), reflejando los distintos regímenes de precio que experimentó Tesla durante el período explosivo 2019-2021. La volatilidad de 59.3% anual se manifiesta claramente en la nube de puntos.

- **Lag 7**: Dispersión significativamente mayor que lag 1. La relación con precios de hace una semana es débil, indicando que Tesla puede experimentar cambios sustanciales de precio en períodos cortos. Los movimientos bruscos semanales son comunes, consistente con su naturaleza de "acción de crecimiento" altamente sensible a noticias y sentimiento del mercado.

### Rezagos - Moderna (MRNA)

```{r lag-plots-mrna, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Gráficos de rezago para Moderna. Comportamiento similar a Tesla con alta dispersión."}

if(is_html_output()) {
  crear_lag_plot_plotly <- function(datos, lag_days, ticker_sel) {
    df <- datos %>%
      filter(Ticker == ticker_sel) %>%
      arrange(Fecha) %>%
      mutate(Close_Lag = lag(Close, lag_days)) %>%
      filter(!is.na(Close_Lag))
    
    max_val <- max(c(df$Close, df$Close_Lag), na.rm = TRUE)
    min_val <- min(c(df$Close, df$Close_Lag), na.rm = TRUE)
    
    fig <- plot_ly(height = 400) %>%
      add_trace(
        data = df,
        x = ~Close_Lag, 
        y = ~Close,
        type = "scatter",
        mode = "markers",
        marker = list(color = colores_tickers[ticker_sel], size = 5, opacity = 0.6),
        hovertemplate = paste0(
          "<b>", ticker_sel, "</b><br>",
          "Precio (t-", lag_days, "): $%{x:,.2f}<br>",
          "Precio (t): $%{y:,.2f}<br>",
          "<extra></extra>"
        ),
        showlegend = FALSE
      ) %>%
      add_trace(
        x = c(min_val, max_val),
        y = c(min_val, max_val),
        type = "scatter",
        mode = "lines",
        line = list(dash = "dash", color = "red", width = 2),
        showlegend = FALSE,
        hoverinfo = "skip"
      ) %>%
      layout(
        title = list(text = paste(ticker_sel, "- Rezago", lag_days, "día(s)"), font = list(size = 14)),
        xaxis = list(title = paste("Precio (t -", lag_days, ")"), tickformat = "$,.0f"),
        yaxis = list(title = "Precio (t)", tickformat = "$,.0f")
      )
    return(fig)
  }
  
  p1 <- crear_lag_plot_plotly(datos_completos, 1, "MRNA")
  p2 <- crear_lag_plot_plotly(datos_completos, 7, "MRNA")
  
  plotly::subplot(p1, p2, nrows = 1, margin = 0.08) %>%
    layout(showlegend = FALSE, title = list(text = "Moderna (MRNA) - Análisis de Rezagos", font = list(size = 16)))
  
} else {
  crear_lag_plot <- function(datos, lag_days, ticker_sel) {
    df <- datos %>%
      filter(Ticker == ticker_sel) %>%
      arrange(Fecha) %>%
      mutate(Close_Lag = lag(Close, lag_days))
    
    ggplot(df, aes(x = Close_Lag, y = Close)) +
      geom_point(color = colores_tickers[ticker_sel], alpha = 0.5, size = 1.5) +
      geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
      labs(title = paste(ticker_sel, "- Rezago", lag_days, "día(s)"),
           x = paste("Precio (t -", lag_days, ")"), y = "Precio (t)") +
      theme_minimal(base_size = 10) +
      scale_x_continuous(labels = dollar_format()) +
      scale_y_continuous(labels = dollar_format())
  }
  
  p1 <- crear_lag_plot(datos_completos, 1, "MRNA")
  p2 <- crear_lag_plot(datos_completos, 7, "MRNA")
  grid.arrange(p1, p2, ncol = 2)
}
```

**Interpretación Moderna (MRNA):**

- **Lag 1**: La mayor dispersión del dataset, reflejando su extrema volatilidad (72.1% anual). Se identifican claramente tres regímenes de precio: pre-vacuna (~$20-80), pico de vacuna (~$200-480), y post-corrección (~$50-150). La nube de puntos muestra múltiples clusters verticales, evidenciando cambios de precio abruptos día a día sin relación lineal consistente con el día anterior.

- **Lag 7**: Dispersión masiva que prácticamente elimina cualquier patrón predecible. La correlación semanal es casi nula - el precio de hace 7 días no ofrece información útil sobre el precio actual. Este comportamiento es típico de acciones impulsadas por eventos específicos (anuncios de vacunas, aprobaciones regulatorias, cambios en demanda pandémica) que generan shocks independientes del comportamiento histórico.

**Síntesis comparativa:**

- **Apple**: Patrón más predecible con fuerte autocorrelación en ambos rezagos. Persistencia de precios día a día y semana a semana.

- **Tesla**: Autocorrelación moderada en lag 1, debilitada en lag 7. Volatilidad alta pero con cierta estructura temporal.

- **Moderna**: Autocorrelación muy débil en ambos rezagos. Comportamiento casi aleatorio dominado por eventos externos más que por dinámica interna de precios. Los modelos de persistencia simple serán insuficientes para esta serie.

## Estacionalidad Anual

El análisis de estacionalidad revela patrones recurrentes a lo largo del año calendario, particularmente relevantes durante el período COVID-19.

### Estacionalidad - Sector Tecnológico

```{r estacionalidad-tech, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Patrón estacional del sector tecnológico (2019-2021). Se observa crecimiento sostenido interrumpido por COVID-19 en marzo 2020."}
datos_mensuales <- datos_completos %>%
  mutate(
    Año = year(Fecha),
    Mes = month(Fecha, label = TRUE)
  ) %>%
  group_by(Ticker, Sector, Año, Mes) %>%
  summarise(Precio_Promedio = mean(Close, na.rm = TRUE), .groups = "drop") %>%
  filter(Año >= 2019 & Año <= 2021)

if(is_html_output()) {
  # VERSION PLOTLY - TECNOLOGIA
  
  colores_años <- c("2019" = "#3498DB", "2020" = "#E74C3C", "2021" = "#27AE60")
  
  fig <- plot_ly(height = 500)
  
  df_tech <- datos_mensuales %>% filter(Sector == "Tecnología")
  
  for(año in c(2019, 2020, 2021)) {
    for(ticker in c("AAPL", "MSFT", "TSLA")) {
      df <- df_tech %>% filter(Año == año, Ticker == ticker)
      
      if(nrow(df) > 0) {
        fig <- fig %>%
          add_trace(
            data = df,
            x = ~Mes,
            y = ~Precio_Promedio,
            type = "scatter",
            mode = "lines+markers",
            name = paste(ticker, año, sep = " - "),
            line = list(color = colores_años[as.character(año)], width = 2.5),
            marker = list(size = 7),
            hovertemplate = paste0(
              "<b>", ticker, " - ", año, "</b><br>",
              "Mes: %{x}<br>",
              "Precio: $%{y:,.2f}<br>",
              "<extra></extra>"
            )
          )
      }
    }
  }
  
  fig <- fig %>%
    layout(
      title = list(text = "Sector Tecnológico - Patrón Estacional (2019-2021)", font = list(size = 16)),
      xaxis = list(title = "Mes"),
      yaxis = list(title = "Precio Promedio ($)", tickformat = "$,.0f"),
      hovermode = "x unified",
      legend = list(
        orientation = "v",
        x = 1.02,
        y = 1,
        font = list(size = 10)
      )
    )
  
  fig
  
} else {
  # VERSION GGPLOT
  df_tech <- datos_mensuales %>% filter(Sector == "Tecnología")
  
  ggplot(df_tech, aes(x = Mes, y = Precio_Promedio, 
                      color = as.factor(Año), group = interaction(Ticker, Año))) +
    geom_line(linewidth = 1) +
    geom_point(size = 2) +
    scale_color_manual(values = c("2019" = "#3498DB", "2020" = "#E74C3C", "2021" = "#27AE60")) +
    labs(title = "Sector Tecnológico - Patrón Estacional (2019-2021)",
         x = "Mes", y = "Precio Promedio ($)", color = "Año") +
    theme_minimal(base_size = 11) +
    theme(legend.position = "right", axis.text.x = element_text(angle = 45, hjust = 1))
}
```

**Interpretación - Tecnología:**

- **Crecimiento consistente (2019):** Apple, Microsoft y Tesla muestran tendencias alcistas estables durante todo el año, con el típico rally de fin de año visible en noviembre-diciembre.

- **Crash y recuperación en V (2020):** Caída dramática en marzo coincidiendo con el inicio de la pandemia. Microsoft y Apple se recuperaron rápidamente (abril-mayo), mientras Tesla mostró aceleración explosiva desde julio, alcanzando ~$300 promedio en diciembre.

- **Consolidación y nuevos máximos (2021):** Microsoft supera los $300 promedio mensual, Apple se estabiliza en ~$150, y Tesla presenta alta volatilidad con picos en octubre-noviembre (~$350-400).

### Estacionalidad - Sector Farmacéutico

```{r estacionalidad-pharma, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Patrón estacional del sector farmacéutico (2019-2021). Destaca el pico dramático de Moderna durante el desarrollo de vacunas."}

if(is_html_output()) {
  # VERSION PLOTLY - FARMACEUTICA
  
  colores_años <- c("2019" = "#3498DB", "2020" = "#E74C3C", "2021" = "#27AE60")
  
  fig <- plot_ly(height = 500)
  
  df_pharma <- datos_mensuales %>% filter(Sector == "Farmacéutica")
  
  for(año in c(2019, 2020, 2021)) {
    for(ticker in c("PFE", "MRNA", "JNJ")) {
      df <- df_pharma %>% filter(Año == año, Ticker == ticker)
      
      if(nrow(df) > 0) {
        fig <- fig %>%
          add_trace(
            data = df,
            x = ~Mes,
            y = ~Precio_Promedio,
            type = "scatter",
            mode = "lines+markers",
            name = paste(ticker, año, sep = " - "),
            line = list(color = colores_años[as.character(año)], width = 2.5),
            marker = list(size = 7),
            hovertemplate = paste0(
              "<b>", ticker, " - ", año, "</b><br>",
              "Mes: %{x}<br>",
              "Precio: $%{y:,.2f}<br>",
              "<extra></extra>"
            )
          )
      }
    }
  }
  
  fig <- fig %>%
    layout(
      title = list(text = "Sector Farmacéutico - Patrón Estacional (2019-2021)", font = list(size = 16)),
      xaxis = list(title = "Mes"),
      yaxis = list(title = "Precio Promedio ($)", tickformat = "$,.0f"),
      hovermode = "x unified",
      legend = list(
        orientation = "v",
        x = 1.02,
        y = 1,
        font = list(size = 10)
      )
    )
  
  fig
  
} else {
  # VERSION GGPLOT
  df_pharma <- datos_mensuales %>% filter(Sector == "Farmacéutica")
  
  ggplot(df_pharma, aes(x = Mes, y = Precio_Promedio, 
                        color = as.factor(Año), group = interaction(Ticker, Año))) +
    geom_line(linewidth = 1) +
    geom_point(size = 2) +
    scale_color_manual(values = c("2019" = "#3498DB", "2020" = "#E74C3C", "2021" = "#27AE60")) +
    labs(title = "Sector Farmacéutico - Patrón Estacional (2019-2021)",
         x = "Mes", y = "Precio Promedio ($)", color = "Año") +
    theme_minimal(base_size = 11) +
    theme(legend.position = "right", axis.text.x = element_text(angle = 45, hjust = 1))
}
```

**Interpretación - Farmacéutica:**

- **Estabilidad pre-pandemia (2019):** J&J, Pfizer y Moderna operan en rangos estables. J&J lidera con ~$130-150, Pfizer ~$35-45, y Moderna (empresa biotecnológica pequeña) en ~$15-25.

- **Transformación durante COVID (2020):** 
  - **Marzo-Mayo:** Volatilidad inicial mientras las empresas ajustan operaciones.
  - **Junio-Noviembre:** Moderna inicia escalada dramática conforme avanza desarrollo de vacuna (~$50 a ~$100).
  - **Diciembre:** Explosión de Moderna alcanzando ~$130 promedio con autorización de emergencia.

- **Pico y corrección (2021):**
  - **Enero-Febrero:** Moderna alcanza máximo histórico (~$400-430 promedio mensual) durante distribución masiva de vacunas.
  - **Marzo en adelante:** Corrección significativa de Moderna hacia ~$280-330, reflejando normalización post-vacunación.
  - **J&J y Pfizer:** Comportamiento más estable. J&J mantiene ~$160-170, Pfizer ~$40-45 con volatilidad moderada.

**Síntesis comparativa sectorial:**

- **Tecnología:** Muestra resiliencia y crecimiento sostenido. El COVID-19 causó disrupción temporal pero aceleró transformación digital, beneficiando al sector.

- **Farmacéutica:** Comportamiento heterogéneo altamente dependiente de eventos COVID-19. Moderna ejemplifica el caso extremo de empresa pequeña transformada por evento global único. J&J demuestra estabilidad defensiva característica de farmacéuticas establecidas.

- **Estacionalidad tradicional:** El rally de fin de año (nov-dic) se observa en tecnología en 2019 y 2021, pero fue eclipsado en farmacéutica durante 2020 por la dinámica de vacunas COVID-19.



## Síntesis de Visualización

Las visualizaciones revelan hallazgos clave que serán profundizados en capítulos posteriores:

1. **Impacto COVID-19:** Claro quiebre estructural en marzo 2020 visible en todas las series.

2. **Divergencia sectorial:** Tecnología muestra recuperación en "V", mientras farmacéuticas tienen comportamiento más heterogéneo.

3. **Volatilidad variable:** Moderna (72%) vs J&J (18%) ejemplifican el rango de comportamientos dentro del mismo sector.

4. **Autocorrelación limitada:** Los rezagos sugieren dependencia débil, indicando que modelos simples de persistencia no serán suficientes.

5. **Estacionalidad interrumpida:** El COVID-19 alteró patrones estacionales tradicionales, creando un nuevo régimen de mercado.

Estos patrones motivan el análisis formal de series de tiempo en los capítulos siguientes.
