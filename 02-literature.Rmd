# Descomposici√≥n y Estacionariedad {#literature}

En este cap√≠tulo analizamos las propiedades estructurales de las series de tiempo de precios de acciones, evaluando la presencia de tendencia, estacionalidad y estacionariedad. Una serie de tiempo financiera se puede descomponer en tres componentes: **tendencia** (movimiento de largo plazo), **estacionalidad** (patrones recurrentes) y **componente irregular** (fluctuaciones aleatorias). Para series de precios de acciones, esperamos tendencias fuertes, estacionalidad d√©bil o ausente, y alta componente irregular debido a la naturaleza ruidosa de los mercados financieros. Este an√°lisis es necesario porque las series financieras t√≠picamente no son estacionarias debido a tendencias de largo plazo, cambios de volatilidad y quiebres estructurales como el COVID-19, lo que genera regresiones espurias y pron√≥sticos poco confiables si no aplicamos transformaciones apropiadas. Dado que tenemos 6 series con comportamientos muy diferentes, seleccionaremos casos representativos de cada sector para an√°lisis detallado: **Apple (AAPL)** como el activo m√°s estable del sector tecnol√≥gico, y **Moderna (MRNA)** como el m√°s vol√°til del sector farmac√©utico con quiebre estructural claro, para luego comparar hallazgos entre todos los activos.

```{r setup-decomp, include=FALSE}
# Suprimir warnings
options(warn = -1)

# Cargar librer√≠as necesarias
library(tidyverse)
library(readxl)
library(lubridate)
library(forecast)
library(tseries)
library(gridExtra)
library(knitr)

# Cargar plotly solo si est√° disponible
plotly_available <- requireNamespace("plotly", quietly = TRUE)
if(plotly_available) {
  library(plotly)
}

# Funci√≥n auxiliar para verificar si el output es HTML
is_html <- function() {
  knitr::is_html_output() && plotly_available
}

# Cargar datos desde Excel
datos_completos <- read_xlsx("datos_yahoo/datasets/datos_completos.xlsx") %>%
  mutate(Fecha = as.Date(Fecha))

# Colores consistentes con el cap√≠tulo anterior
colores_tickers <- c(
  "AAPL" = "#007AFF", "MSFT" = "#34C759", "TSLA" = "#FF3B30",
  "PFE" = "#AF52DE", "MRNA" = "#FF9500", "JNJ" = "#E91E63"
)
```

## Descomposici√≥n de Series de Tiempo

### Apple (AAPL) - Sector Tecnolog√≠a

```{r descomp-aapl, echo=FALSE, warning=FALSE, message=FALSE, fig.height=8, fig.cap="Descomposici√≥n multiplicativa de Apple (AAPL). La tendencia alcista es dominante, con componente estacional d√©bil y residuos relativamente peque√±os en per√≠odos estables."}
# Preparar datos de AAPL
datos_aapl <- datos_completos %>%
  filter(Ticker == "AAPL") %>%
  arrange(Fecha)

# Crear objeto ts (serie de tiempo semanal - 52 semanas/a√±o)
ts_aapl <- ts(datos_aapl$Close, 
              start = c(year(min(datos_aapl$Fecha)), 
                       week(min(datos_aapl$Fecha))),
              frequency = 52)

# Descomposici√≥n multiplicativa (m√°s apropiada para precios)
decomp_aapl <- decompose(ts_aapl, type = "multiplicative")

# Visualizaci√≥n
plot(decomp_aapl, col = colores_tickers["AAPL"])
```

**Interpretaci√≥n - Apple (AAPL):**

1. **Serie Observada:** Crecimiento sostenido de \$22.58 a \$259.02, con ca√≠da pronunciada en marzo 2020 (COVID-19) seguida de recuperaci√≥n en "V".

2. **Tendencia:** Claramente alcista con tres fases:
   - 2015-2019: Crecimiento moderado y constante
   - 2020: Disrupci√≥n por COVID-19 (quiebre estructural)
   - 2021-2025: Aceleraci√≥n del crecimiento

3. **Estacionalidad:** Componente estacional d√©bil (oscilaciones ~¬±2-3% alrededor de 1.0 en modelo multiplicativo), indicando que los patrones mensuales/semanales no son fuertes predictores.

4. **Residuos (Irregular):** Relativamente peque√±os en per√≠odos normales, pero con picos pronunciados durante eventos extremos (COVID-19, anuncios corporativos).

**Conclusi√≥n - AAPL:** La tendencia domina el comportamiento. La estacionalidad es pr√°cticamente despreciable, confirmando que los precios accionarios son principalmente impulsados por tendencias de largo plazo y eventos espec√≠ficos, no por patrones recurrentes predecibles.

### Moderna (MRNA) - Sector Farmac√©utico

```{r descomp-mrna, echo=FALSE, warning=FALSE, message=FALSE, fig.height=8, fig.cap="Descomposici√≥n multiplicativa de Moderna (MRNA). Destaca el cambio de r√©gimen extremo durante el per√≠odo de vacunas COVID-19, con residuos muy grandes indicando alta componente irregular."}
# Preparar datos de MRNA
datos_mrna <- datos_completos %>%
  filter(Ticker == "MRNA") %>%
  arrange(Fecha)

# Crear objeto ts (serie de tiempo semanal)
ts_mrna <- ts(datos_mrna$Close, 
              start = c(year(min(datos_mrna$Fecha)), 
                       week(min(datos_mrna$Fecha))),
              frequency = 52)

# Descomposici√≥n multiplicativa
decomp_mrna <- decompose(ts_mrna, type = "multiplicative")

# Visualizaci√≥n
plot(decomp_mrna, col = colores_tickers["MRNA"])
```

**Interpretaci√≥n - Moderna (MRNA):**

1. **Serie Observada:** Comportamiento extremadamente vol√°til con pico dram√°tico durante desarrollo de vacunas COVID-19 (alcanzando \$484.47 desde \$12.26).

2. **Tendencia:** Dos reg√≠menes claramente diferenciados:
   - 2018-2020: Empresa biotecnol√≥gica peque√±a (~\$15-30)
   - 2020-2021: Explosi√≥n por vacuna COVID-19 (pico ~\$480)
   - 2022-2025: Correcci√≥n y nueva estabilidad (~\$40-150)

3. **Estacionalidad:** Pr√°cticamente inexistente. Las fluctuaciones son dominadas por eventos espec√≠ficos (ensayos cl√≠nicos, aprobaciones regulatorias) no por patrones temporales recurrentes.

4. **Residuos (Irregular):** **Extremadamente grandes** (hasta ¬±40% en modelo multiplicativo), indicando que la mayor parte de la variabilidad NO es explicada por tendencia ni estacionalidad. El comportamiento es altamente dependiente de eventos discretos impredecibles.

**Conclusi√≥n - MRNA:** Serie altamente no estacionaria con quiebre estructural extremo. Los m√©todos tradicionales de descomposici√≥n son insuficientes para capturar la din√°mica. Este tipo de serie requiere modelos de cambio de r√©gimen o an√°lisis de eventos.

**Implicaciones de la Descomposici√≥n para el Modelado:**

El an√°lisis de descomposici√≥n de ambos activos (y por extensi√≥n, de las otras 4 series) revel√≥ patrones consistentes que son cr√≠ticos para las decisiones de modelado:

1. **Tendencia es el componente dominante** en todas las series (>90% de la variabilidad explicada seg√∫n los gr√°ficos de descomposici√≥n)
2. **Estacionalidad es pr√°cticamente despreciable** - las oscilaciones semanales/mensuales son m√≠nimas y no sistem√°ticas
3. **Residuos var√≠an seg√∫n el activo:**
   - Empresas establecidas (AAPL, MSFT, JNJ): Residuos moderados (~5-10% de la variabilidad)
   - Empresas vol√°tiles/disruptivas (TSLA, MRNA): Residuos muy altos (30-50% de la variabilidad), dominados por eventos espec√≠ficos impredecibles
4. **Quiebres estructurales evidentes** durante COVID-19 en todas las series

**Nota:** Los residuos (componente "random" en los gr√°ficos de descomposici√≥n) representan la variabilidad que NO puede ser explicada por tendencia ni estacionalidad. Residuos grandes indican alta dependencia de eventos aleatorios o noticias espec√≠ficas.

**Por lo tanto, los modelos de pron√≥stico deben enfocarse en:**

- **Capturar tendencias no lineales** (posiblemente con suavizamiento o modelos de tendencia estoc√°stica)
- **Modelar volatilidad variable en el tiempo** (modelos GARCH/EGARCH para heterocedasticidad)
- **Permitir quiebres estructurales** (modelos con cambios de r√©gimen o variables dummy para eventos como COVID-19)
- **Minimizar √©nfasis en estacionalidad** (no es necesaria diferenciaci√≥n estacional: D=0 en modelos SARIMA)

Estas conclusiones guiar√°n las decisiones de especificaci√≥n de modelos en los cap√≠tulos posteriores.

## An√°lisis de Estacionariedad

### ¬øQu√© es la Estacionariedad?

Una serie de tiempo es **estacionaria** si sus propiedades estad√≠sticas (media, varianza, autocorrelaci√≥n) no cambian con el tiempo:

$$E[Y_t] = \mu \quad \text{(media constante)}$$
$$Var(Y_t) = \sigma^2 \quad \text{(varianza constante)}$$
$$Cov(Y_t, Y_{t-k}) = \gamma_k \quad \text{(autocovarianza que solo depende del rezago } k \text{)}$$

**¬øPor qu√© es importante?**

- Muchos modelos de series de tiempo (ARIMA, VAR) asumen estacionariedad
- Series no estacionarias pueden producir pron√≥sticos poco confiables
- La diferenciaci√≥n puede inducir estacionariedad

### Prueba Aumentada de Dickey-Fuller (ADF)

La prueba ADF eval√∫a la **hip√≥tesis nula de ra√≠z unitaria** (no estacionariedad):

- **$H_0$:** La serie tiene ra√≠z unitaria (es no estacionaria)
- **$H_1$:** La serie es estacionaria

**Criterio de decisi√≥n:**

- Si p-valor < 0.05 ‚Üí Rechazamos $H_0$ ‚Üí **Serie es estacionaria**
- Si p-valor ‚â• 0.05 ‚Üí No rechazamos $H_0$ ‚Üí **Serie es no estacionaria**

### Pruebas ADF: Precios en Niveles

```{r adf-niveles, echo=FALSE, warning=FALSE, message=FALSE}
# Funci√≥n para realizar prueba ADF y extraer resultados
realizar_adf <- function(serie, nombre) {
  test <- adf.test(serie, alternative = "stationary")
  data.frame(
    Serie = nombre,
    Estadistico = round(test$statistic, 4),
    P_valor = round(test$p.value, 4),
    Conclusion = ifelse(test$p.value < 0.05, "Estacionaria", "No Estacionaria")
  )
}

# Realizar pruebas ADF para todos los activos (precios en niveles)
resultados_adf_niveles <- map_dfr(
  unique(datos_completos$Ticker),
  function(ticker) {
    serie <- datos_completos %>% 
      filter(Ticker == ticker) %>% 
      pull(Close)
    realizar_adf(serie, ticker)
  }
)

kable(resultados_adf_niveles,
      col.names = c("Activo", "Estad√≠stico ADF", "P-valor", "Conclusi√≥n"),
      caption = "Resultados de la prueba ADF para precios en niveles. Todas las series son no estacionarias (p-valor > 0.05), confirmando la presencia de ra√≠z unitaria.",
      align = c('l', 'r', 'r', 'l'))
```

**Interpretaci√≥n - Precios en Niveles:**

Como era de esperar, **todas las series de precios son no estacionarias** (p-valores muy altos, t√≠picamente >0.90). Esto confirma que:

1. Los precios tienen **tendencia estoc√°stica** (ra√≠z unitaria)
2. La media y varianza cambian con el tiempo
3. No podemos usar directamente estos datos para modelado ARIMA sin transformaciones

**Visualizaci√≥n de No-Estacionariedad:**

```{r viz-no-estacionariedad, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.cap="Comparaci√≥n de media y varianza m√≥vil (ventana de 60 d√≠as) para AAPL y MRNA. Ambas series muestran media y varianza no constantes, confirmando no estacionariedad."}
# Funci√≥n para calcular media m√≥vil manualmente
rolling_mean <- function(x, k) {
  n <- length(x)
  result <- rep(NA, n)
  for(i in k:n) {
    result[i] <- mean(x[(i-k+1):i], na.rm = TRUE)
  }
  return(result)
}

# Funci√≥n para calcular desviaci√≥n est√°ndar m√≥vil
rolling_sd <- function(x, k) {
  n <- length(x)
  result <- rep(NA, n)
  for(i in k:n) {
    result[i] <- sd(x[(i-k+1):i], na.rm = TRUE)
  }
  return(result)
}

# Calcular estad√≠sticos m√≥viles
datos_rolling <- datos_completos %>%
  filter(Ticker %in% c("AAPL", "MRNA")) %>%
  arrange(Ticker, Fecha) %>%
  group_by(Ticker) %>%
  mutate(
    Media_Movil = rolling_mean(Close, 60),
    Desv_Movil = rolling_sd(Close, 60)
  ) %>%
  ungroup()

if(is_html()) {
  # VERSI√ìN INTERACTIVA CON PLOTLY
  
  # Panel 1: Precio vs Media M√≥vil
  p1 <- plot_ly(height = 300) %>%
    add_trace(
      data = datos_rolling %>% filter(Ticker == "AAPL"),
      x = ~Fecha, y = ~Close,
      type = "scatter", mode = "lines",
      name = "AAPL - Precio",
      line = list(color = colores_tickers["AAPL"], width = 1),
      opacity = 0.4
    ) %>%
    add_trace(
      data = datos_rolling %>% filter(Ticker == "AAPL"),
      x = ~Fecha, y = ~Media_Movil,
      type = "scatter", mode = "lines",
      name = "AAPL - Media M√≥vil 60d",
      line = list(color = colores_tickers["AAPL"], width = 2.5)
    ) %>%
    add_trace(
      data = datos_rolling %>% filter(Ticker == "MRNA"),
      x = ~Fecha, y = ~Close,
      type = "scatter", mode = "lines",
      name = "MRNA - Precio",
      line = list(color = colores_tickers["MRNA"], width = 1),
      opacity = 0.4
    ) %>%
    add_trace(
      data = datos_rolling %>% filter(Ticker == "MRNA"),
      x = ~Fecha, y = ~Media_Movil,
      type = "scatter", mode = "lines",
      name = "MRNA - Media M√≥vil 60d",
      line = list(color = colores_tickers["MRNA"], width = 2.5)
    ) %>%
    layout(
      title = "Precio vs Media M√≥vil (60 d√≠as)",
      xaxis = list(title = ""),
      yaxis = list(title = "Precio ($)"),
      hovermode = "x unified",
      showlegend = TRUE,
      legend = list(x = 0.01, y = 0.99)
    )
  
  # Panel 2: Volatilidad M√≥vil
  p2 <- plot_ly(height = 300) %>%
    add_trace(
      data = datos_rolling %>% filter(Ticker == "AAPL"),
      x = ~Fecha, y = ~Desv_Movil,
      type = "scatter", mode = "lines",
      name = "AAPL",
      line = list(color = colores_tickers["AAPL"], width = 2)
    ) %>%
    add_trace(
      data = datos_rolling %>% filter(Ticker == "MRNA"),
      x = ~Fecha, y = ~Desv_Movil,
      type = "scatter", mode = "lines",
      name = "MRNA",
      line = list(color = colores_tickers["MRNA"], width = 2)
    ) %>%
    layout(
      title = "Desviaci√≥n Est√°ndar M√≥vil (60 d√≠as)",
      xaxis = list(title = "Fecha"),
      yaxis = list(title = "Volatilidad ($)"),
      hovermode = "x unified",
      showlegend = TRUE,
      legend = list(x = 0.01, y = 0.99)
    )
  
  # Mostrar ambos gr√°ficos
  subplot(p1, p2, nrows = 2, shareX = TRUE, titleY = TRUE, margin = 0.08)
  
} else {
  # VERSI√ìN EST√ÅTICA CON GGPLOT
  p1 <- ggplot(datos_rolling, aes(x = Fecha)) +
    geom_line(aes(y = Close, color = Ticker), alpha = 0.3) +
    geom_line(aes(y = Media_Movil, color = Ticker), linewidth = 1) +
    scale_color_manual(values = colores_tickers) +
    labs(title = "Precio vs Media M√≥vil (60 d√≠as)",
         y = "Precio ($)", x = NULL) +
    theme_minimal() +
    theme(legend.position = "top")
  
  p2 <- ggplot(datos_rolling, aes(x = Fecha, y = Desv_Movil, color = Ticker)) +
    geom_line(linewidth = 1) +
    scale_color_manual(values = colores_tickers) +
    labs(title = "Desviaci√≥n Est√°ndar M√≥vil (60 d√≠as)",
         y = "Volatilidad ($)", x = "Fecha") +
    theme_minimal() +
    theme(legend.position = "top")
  
  grid.arrange(p1, p2, ncol = 1)
}
```

La figura confirma visualmente la no estacionariedad:

- **Media m√≥vil:** Claramente creciente para AAPL, con quiebre estructural para MRNA
- **Volatilidad m√≥vil:** No constante, con picos durante eventos extremos (especialmente MRNA en 2020-2021)

## Transformaciones para Inducir Estacionariedad

### Transformaci√≥n Logar√≠tmica

**¬øPor qu√© necesitamos transformar los datos?**

Las series de precios de acciones suelen presentar dos problemas que violan los supuestos de modelos ARIMA:

1. **Heterocedasticidad:** La varianza crece con el nivel de precios (cuando el precio es $200, las fluctuaciones son mayores que cuando era $20)
2. **No-normalidad:** Las distribuciones de cambios en precios no son normales cuando trabajamos con valores absolutos

**Transformaciones disponibles:**

Existen varias transformaciones para estabilizar la varianza:

| Transformaci√≥n | F√≥rmula | Cu√°ndo usarla | Ventajas | Desventajas |
|---------------|---------|---------------|----------|-------------|
| **Logar√≠tmica** | $\ln(P_t)$ | Varianza proporcional al nivel (m√°s com√∫n en finanzas) | Interpretable como retornos continuos | No funciona con valores ‚â§0 |
| **Ra√≠z cuadrada** | $\sqrt{P_t}$ | Varianza proporcional al nivel (datos de conteo) | Simple, funciona con cero | Menos interpretable en finanzas |
| **Box-Cox** | $\frac{P_t^\lambda - 1}{\lambda}$ | Cuando Œª √≥ptimo ‚â† 0 ni 1 | Flexible, encuentra transformaci√≥n √≥ptima | Dif√≠cil de interpretar |
| **Inversa** | $\frac{1}{P_t}$ | Varianza muy grande para valores altos | Estabiliza varianza fuerte | Invierte orden, poco intuitiva |

**¬øPor qu√© elegimos la transformaci√≥n logar√≠tmica para precios de acciones?**

Hay **3 razones principales**:

1. **Interpretabilidad financiera:**
   $$r_t = \ln(P_t) - \ln(P_{t-1}) = \ln\left(\frac{P_t}{P_{t-1}}\right) \approx \frac{P_t - P_{t-1}}{P_{t-1}}$$
   
   La primera diferencia de log-precios son **retornos continuos**, el est√°ndar en finanzas cuantitativas.

2. **Estabilizaci√≥n de varianza:**
   - Convierte crecimiento multiplicativo en aditivo
   - Una acci√≥n que duplica su valor (√ó2) tiene el mismo impacto que una que se reduce a la mitad (√ó0.5) en escala logar√≠tmica

3. **Propiedades matem√°ticas convenientes:**
   - Los retornos logar√≠tmicos se pueden **sumar** a trav√©s del tiempo: $r_{1‚Üí3} = r_1 + r_2 + r_3$
   - Los retornos simples NO: $(1+r_1)(1+r_2)(1+r_3) - 1$ (multiplicaci√≥n, m√°s complejo)

**Ejemplo num√©rico:**

Supongamos AAPL pasa de \$100 ‚Üí \$110 ‚Üí \$99:

- **Retornos simples:** +10%, luego -10% ‚Üí Total: $100 √ó 1.10 √ó 0.90 = \$99$ ‚ùå (no es 0%)
- **Retornos logar√≠tmicos:** +9.53%, luego -10.54% ‚Üí Total: 9.53% - 10.54% = -1.01% ‚úÖ (se suman directamente)

**Aplicaci√≥n a precios:**

$$\text{Log-Precio}_t = \ln(P_t)$$

**Ventaja:** Los retornos logar√≠tmicos son aproximadamente retornos continuos:

$$r_t = \ln(P_t) - \ln(P_{t-1}) = \ln\left(\frac{P_t}{P_{t-1}}\right)$$

```{r log-precios, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.cap="Comparaci√≥n de precios originales vs logar√≠tmicos para AAPL y MRNA. La transformaci√≥n log reduce parcialmente la heterocedasticidad pero NO elimina la tendencia."}
# Aplicar transformaci√≥n log
datos_log <- datos_completos %>%
  filter(Ticker %in% c("AAPL", "MRNA")) %>%
  mutate(Log_Close = log(Close))

if(is_html()) {
  # VERSI√ìN INTERACTIVA CON PLOTLY
  
  p1 <- plot_ly(height = 300) %>%
    add_trace(
      data = datos_log %>% filter(Ticker == "AAPL"),
      x = ~Fecha, y = ~Close,
      type = "scatter", mode = "lines",
      name = "AAPL",
      line = list(color = colores_tickers["AAPL"], width = 2)
    ) %>%
    add_trace(
      data = datos_log %>% filter(Ticker == "MRNA"),
      x = ~Fecha, y = ~Close,
      type = "scatter", mode = "lines",
      name = "MRNA",
      line = list(color = colores_tickers["MRNA"], width = 2)
    ) %>%
    layout(
      title = "Precios Originales",
      xaxis = list(title = ""),
      yaxis = list(title = "Precio ($)"),
      hovermode = "x unified"
    )
  
  p2 <- plot_ly(height = 300) %>%
    add_trace(
      data = datos_log %>% filter(Ticker == "AAPL"),
      x = ~Fecha, y = ~Log_Close,
      type = "scatter", mode = "lines",
      name = "AAPL",
      line = list(color = colores_tickers["AAPL"], width = 2)
    ) %>%
    add_trace(
      data = datos_log %>% filter(Ticker == "MRNA"),
      x = ~Fecha, y = ~Log_Close,
      type = "scatter", mode = "lines",
      name = "MRNA",
      line = list(color = colores_tickers["MRNA"], width = 2)
    ) %>%
    layout(
      title = "Precios Logar√≠tmicos",
      xaxis = list(title = "Fecha"),
      yaxis = list(title = "Log(Precio)"),
      hovermode = "x unified"
    )
  
  subplot(p1, p2, nrows = 2, shareX = TRUE, titleY = TRUE, margin = 0.08)
  
} else {
  # VERSI√ìN EST√ÅTICA
  p1 <- ggplot(datos_log, aes(x = Fecha, y = Close, color = Ticker)) +
    geom_line() +
    scale_color_manual(values = colores_tickers) +
    labs(title = "Precios Originales", y = "Precio ($)", x = NULL) +
    theme_minimal() +
    theme(legend.position = "none")
  
  p2 <- ggplot(datos_log, aes(x = Fecha, y = Log_Close, color = Ticker)) +
    geom_line() +
    scale_color_manual(values = colores_tickers) +
    labs(title = "Precios Logar√≠tmicos", y = "Log(Precio)", x = "Fecha") +
    theme_minimal() +
    theme(legend.position = "top")
  
  grid.arrange(p1, p2, ncol = 1)
}
```

**Prueba ADF en Log-Precios:**

```{r adf-log, echo=FALSE, warning=FALSE, message=FALSE}
# Realizar pruebas ADF para log-precios
resultados_adf_log <- map_dfr(
  unique(datos_completos$Ticker),
  function(ticker) {
    serie <- datos_completos %>% 
      filter(Ticker == ticker) %>% 
      pull(Close) %>%
      log()
    realizar_adf(serie, paste0(ticker, " (Log)"))
  }
)

kable(resultados_adf_log,
      col.names = c("Activo", "Estad√≠stico ADF", "P-valor", "Conclusi√≥n"),
      caption = "Resultados de la prueba ADF para log-precios. La transformaci√≥n logar√≠tmica NO es suficiente para inducir estacionariedad.",
      align = c('l', 'r', 'r', 'l'))
```

**Conclusi√≥n:** La transformaci√≥n logar√≠tmica **ayuda a estabilizar la varianza** pero **NO elimina la tendencia**. Todas las series siguen siendo no estacionarias.

### ¬øCu√°ntas diferenciaciones necesitamos?

Aunque la prueba ADF ya confirm√≥ no estacionariedad, podemos usar la funci√≥n `ndiffs()` del paquete `forecast` para determinar cu√°ntas diferenciaciones son necesarias:

```{r ndiffs-test, echo=FALSE, warning=FALSE, message=FALSE}
# Determinar n√∫mero de diferenciaciones necesarias para cada activo
ndiffs_resultados <- map_dfr(
  unique(datos_completos$Ticker),
  function(ticker) {
    serie_log <- datos_completos %>% 
      filter(Ticker == ticker) %>% 
      pull(Close) %>%
      log()
    
    # Usar ndiffs con prueba ADF
    n_dif <- forecast::ndiffs(serie_log, test = "adf")
    
    data.frame(
      Ticker = ticker,
      Diferenciaciones_Necesarias = n_dif
    )
  }
)

kable(ndiffs_resultados,
      col.names = c("Activo", "# Diferenciaciones Necesarias (d)"),
      caption = "N√∫mero de diferenciaciones necesarias para inducir estacionariedad seg√∫n prueba ADF. Todas las series requieren d=1.",
      align = c('l', 'c'))
```

**Interpretaci√≥n:**

- **d = 1:** Una diferenciaci√≥n es suficiente (todas las series)
- Esto confirma que las series de precios son **I(1)** (integradas de orden 1)
- En modelos ARIMA, usaremos: **ARIMA(p, d=1, q)** donde d=1

**¬øPor qu√© d=1 y no d=2 o d=3?**

- **d=0:** Serie ya estacionaria ‚Üí NO aplica a precios
- **d=1:** Elimina tendencia estoc√°stica (ra√≠z unitaria) ‚Üí **Este es nuestro caso** ‚úÖ
- **d=2:** Para series con tendencia cuadr√°tica ‚Üí Sobre-diferenciaci√≥n, genera autocorrelaci√≥n negativa artificial
- **d‚â•3:** Casi nunca necesario en series econ√≥micas

**Regla pr√°ctica:** La mayor√≠a de series econ√≥micas/financieras son I(0) o I(1). Usar d>1 es raro y generalmente un error.

### Primera Diferenciaci√≥n (Retornos)

**Objetivo:** Eliminar tendencia calculando cambios per√≠odo a per√≠odo.

**Primera diferencia:**

$$\Delta Y_t = Y_t - Y_{t-1}$$

**En el contexto financiero, la primera diferencia de log-precios son los retornos logar√≠tmicos:**

$$r_t = \ln(P_t) - \ln(P_{t-1}) \approx \frac{P_t - P_{t-1}}{P_{t-1}} = \text{Retorno Simple}$$

```{r retornos, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.cap="Retornos logar√≠tmicos diarios para todos los activos. Las series de retornos eliminan la tendencia pero muestran volatilidad variable (clusters de volatilidad durante COVID-19)."}
# Calcular retornos logar√≠tmicos
datos_retornos <- datos_completos %>%
  arrange(Ticker, Fecha) %>%
  group_by(Ticker) %>%
  mutate(
    Log_Return = c(NA, diff(log(Close))) * 100  # En porcentaje
  ) %>%
  ungroup() %>%
  filter(!is.na(Log_Return))

if(is_html()) {
  # VERSI√ìN PLOTLY INTERACTIVA
  
  # Panel Tech
  p_tech <- plot_ly(height = 320) %>%
    add_trace(
      data = datos_retornos %>% filter(Ticker == "AAPL"),
      x = ~Fecha, y = ~Log_Return,
      type = "scatter", mode = "lines",
      name = "AAPL",
      line = list(color = colores_tickers["AAPL"], width = 0.5),
      opacity = 0.7
    ) %>%
    add_trace(
      data = datos_retornos %>% filter(Ticker == "MSFT"),
      x = ~Fecha, y = ~Log_Return,
      type = "scatter", mode = "lines",
      name = "MSFT",
      line = list(color = colores_tickers["MSFT"], width = 0.5),
      opacity = 0.7
    ) %>%
    add_trace(
      data = datos_retornos %>% filter(Ticker == "TSLA"),
      x = ~Fecha, y = ~Log_Return,
      type = "scatter", mode = "lines",
      name = "TSLA",
      line = list(color = colores_tickers["TSLA"], width = 0.5),
      opacity = 0.7
    ) %>%
    add_trace(
      x = range(datos_retornos$Fecha),
      y = c(0, 0),
      type = "scatter", mode = "lines",
      name = "Cero",
      line = list(color = "black", width = 1, dash = "dash"),
      showlegend = FALSE
    ) %>%
    layout(
      title = "Retornos - Sector Tecnolog√≠a",
      xaxis = list(title = ""),
      yaxis = list(title = "Retorno (%)"),
      hovermode = "x unified"
    )
  
  # Panel Pharma
  p_pharma <- plot_ly(height = 320) %>%
    add_trace(
      data = datos_retornos %>% filter(Ticker == "PFE"),
      x = ~Fecha, y = ~Log_Return,
      type = "scatter", mode = "lines",
      name = "PFE",
      line = list(color = colores_tickers["PFE"], width = 0.5),
      opacity = 0.7
    ) %>%
    add_trace(
      data = datos_retornos %>% filter(Ticker == "MRNA"),
      x = ~Fecha, y = ~Log_Return,
      type = "scatter", mode = "lines",
      name = "MRNA",
      line = list(color = colores_tickers["MRNA"], width = 0.5),
      opacity = 0.7
    ) %>%
    add_trace(
      data = datos_retornos %>% filter(Ticker == "JNJ"),
      x = ~Fecha, y = ~Log_Return,
      type = "scatter", mode = "lines",
      name = "JNJ",
      line = list(color = colores_tickers["JNJ"], width = 0.5),
      opacity = 0.7
    ) %>%
    add_trace(
      x = range(datos_retornos$Fecha),
      y = c(0, 0),
      type = "scatter", mode = "lines",
      name = "Cero",
      line = list(color = "black", width = 1, dash = "dash"),
      showlegend = FALSE
    ) %>%
    layout(
      title = "Retornos - Sector Farmac√©utico",
      xaxis = list(title = "Fecha"),
      yaxis = list(title = "Retorno (%)"),
      hovermode = "x unified"
    )
  
  subplot(p_tech, p_pharma, nrows = 2, shareX = TRUE, titleY = TRUE, margin = 0.08)
  
} else {
  # VERSI√ìN EST√ÅTICA
  ggplot(datos_retornos, aes(x = Fecha, y = Log_Return, color = Ticker)) +
    geom_line(alpha = 0.6, linewidth = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    facet_wrap(~Sector, ncol = 1, scales = "free_y") +
    scale_color_manual(values = colores_tickers) +
    labs(title = "Retornos Logar√≠tmicos Diarios por Sector",
         y = "Retorno (%)", x = "Fecha") +
    theme_minimal(base_size = 11) +
    theme(legend.position = "bottom")
}
```

**Observaciones Clave - Retornos:**

1. **Media aparentemente constante** alrededor de 0% (aunque ligeramente positiva debido a tendencia alcista)
2. **Volatilidad NO constante:** Clusters de volatilidad evidentes durante:
   - Marzo 2020: Crash COVID-19 (retornos diarios de ¬±20-30%)
   - 2020-2021: Alta volatilidad en MRNA durante desarrollo de vacunas
   - Per√≠odos normales: Volatilidad ~1-2% diaria
3. **Outliers extremos:** Retornos de hasta ¬±35% en d√≠as espec√≠ficos

### Prueba ADF en Retornos

```{r adf-retornos, echo=FALSE, warning=FALSE, message=FALSE}
# Realizar pruebas ADF para retornos
resultados_adf_retornos <- map_dfr(
  unique(datos_completos$Ticker),
  function(ticker) {
    serie <- datos_completos %>% 
      filter(Ticker == ticker) %>%
      arrange(Fecha) %>%
      pull(Close) %>%
      log() %>%
      diff()
    
    realizar_adf(na.omit(serie), paste0(ticker, " (Retornos)"))
  }
)

kable(resultados_adf_retornos,
      col.names = c("Activo", "Estad√≠stico ADF", "P-valor", "Conclusi√≥n"),
      caption = "Resultados de la prueba ADF para retornos logar√≠tmicos. TODAS las series de retornos son estacionarias (p-valor < 0.05), confirmando que la primera diferenciaci√≥n es suficiente.",
      align = c('l', 'r', 'r', 'l'))
```

**Conclusi√≥n - Retornos:**

‚úÖ **TODAS las series de retornos son estacionarias** (p-valores < 0.01)

Esto confirma que:

1. **Una diferenciaci√≥n es suficiente** para inducir estacionariedad (d=1)
2. Las series de precios son **integradas de orden 1**: $I(1)$
3. Los retornos son **integrados de orden 0**: $I(0)$, es decir, estacionarios
4. Podemos modelar los retornos con modelos ARMA, GARCH, etc.

**Nota importante sobre sobre-diferenciaci√≥n:**

¬øPor qu√© NO aplicamos d=2 (diferenciar dos veces)?

- Con **d=1** (retornos): Series estacionarias con p-valores < 0.01 ‚úÖ
- Con **d=2** (diferencia de retornos): Generar√≠amos autocorrelaci√≥n negativa artificial ‚ùå
- **Regla:** Usar el m√≠nimo n√∫mero de diferenciaciones necesarias

En modelos ARIMA para retornos usaremos: **ARIMA(p, d=0, q)** porque ya aplicamos la diferenciaci√≥n manualmente al calcular retornos.

### Estad√≠sticas Descriptivas de los Retornos

```{r stats-retornos, echo=FALSE, warning=FALSE, message=FALSE}
# Funciones para calcular asimetr√≠a y curtosis manualmente
calc_skewness <- function(x) {
  x <- x[!is.na(x)]
  n <- length(x)
  m <- mean(x)
  s <- sd(x)
  sum((x - m)^3) / (n * s^3)
}

calc_kurtosis <- function(x) {
  x <- x[!is.na(x)]
  n <- length(x)
  m <- mean(x)
  s <- sd(x)
  sum((x - m)^4) / (n * s^4)
}

# Calcular estad√≠sticas descriptivas de retornos
stats_retornos <- datos_retornos %>%
  group_by(Ticker, Sector) %>%
  summarise(
    Media = mean(Log_Return, na.rm = TRUE),
    Mediana = median(Log_Return, na.rm = TRUE),
    Desv_Est = sd(Log_Return, na.rm = TRUE),
    Min = min(Log_Return, na.rm = TRUE),
    Max = max(Log_Return, na.rm = TRUE),
    Asimetria = calc_skewness(Log_Return),
    Curtosis = calc_kurtosis(Log_Return),
    .groups = "drop"
  )

kable(stats_retornos,
      digits = 3,
      col.names = c("Ticker", "Sector", "Media (%)", "Mediana (%)", 
                    "Desv. Est. (%)", "M√≠n (%)", "M√°x (%)", "Asimetr√≠a", "Curtosis"),
      caption = "Estad√≠sticas descriptivas de retornos logar√≠tmicos diarios. Todos los activos presentan curtosis >3, indicando colas pesadas (mayor probabilidad de eventos extremos que la distribuci√≥n normal).")
```

**Interpretaci√≥n de Estad√≠sticas:**

1. **Media positiva pero peque√±a** (0.05% - 0.40% diario):
   - TSLA: Mayor retorno promedio (+0.40% diario ‚âà +100% anual compuesto)
   - PFE: Retorno negativo promedio (-0.01% diario ‚âà -2.5% anual)

2. **Volatilidad (Desv. Est.) var√≠a enormemente:**
   - JNJ: 1.14% (m√°s estable, empresa defensiva)
   - MRNA: 5.37% (extremadamente vol√°til)
   - TSLA: 3.77% (alta volatilidad caracter√≠stica de Tesla)

3. **Asimetr√≠a negativa** en la mayor√≠a:
   - Indica mayor frecuencia de retornos negativos extremos (crashes)
   - Consistente con comportamiento de mercados financieros

4. **Curtosis muy alta** (todas >3, muchas >5):
   - Colas pesadas: Mayor probabilidad de eventos extremos que distribuci√≥n normal
   - MRNA: Curtosis extrema (eventos extremos muy frecuentes)
   - Implicaci√≥n: Modelos deben capturar eventos extremos (usar GARCH, no solo ARMA)

## Visualizaci√≥n ACF/PACF de Retornos

Las funciones de autocorrelaci√≥n ayudan a identificar la estructura de dependencia temporal en los retornos:

- **ACF:** Autocorrelaci√≥n entre $r_t$ y $r_{t-k}$
- **PACF:** Autocorrelaci√≥n parcial (controlando por rezagos intermedios)

```{r acf-pacf-retornos, echo=FALSE, warning=FALSE, message=FALSE, fig.height=8, fig.cap="Funciones ACF y PACF para retornos de AAPL y MRNA. Autocorrelaciones d√©biles sugieren que los retornos son casi ruido blanco, pero los cuadrados de retornos (no mostrados) presentar√≠an autocorrelaci√≥n significativa debido a clusters de volatilidad."}
# ACF y PACF para AAPL
par(mfrow = c(2, 2))

datos_aapl_ret <- datos_retornos %>% filter(Ticker == "AAPL") %>% pull(Log_Return)
acf(datos_aapl_ret, lag.max = 30, main = "ACF - AAPL (Retornos)", col = colores_tickers["AAPL"])
pacf(datos_aapl_ret, lag.max = 30, main = "PACF - AAPL (Retornos)", col = colores_tickers["AAPL"])

datos_mrna_ret <- datos_retornos %>% filter(Ticker == "MRNA") %>% pull(Log_Return)
acf(datos_mrna_ret, lag.max = 30, main = "ACF - MRNA (Retornos)", col = colores_tickers["MRNA"])
pacf(datos_mrna_ret, lag.max = 30, main = "PACF - MRNA (Retornos)", col = colores_tickers["MRNA"])

par(mfrow = c(1, 1))
```

**Interpretaci√≥n ACF/PACF:**

1. **AAPL:**
   - ACF: Autocorrelaciones muy peque√±as y r√°pidamente decrecientes
   - PACF: Solo lag 1 ligeramente significativo
   - Conclusi√≥n: Retornos cercanos a **ruido blanco** (independientes)

2. **MRNA:**
   - ACF: Pr√°cticamente todas las autocorrelaciones dentro de bandas de confianza
   - PACF: Sin estructura clara
   - Conclusi√≥n: Retornos altamente **impredecibles** bas√°ndose solo en valores pasados

**Implicaci√≥n:** Los retornos tienen poca memoria lineal, lo que dificulta el pron√≥stico basado √∫nicamente en valores pasados de retornos. Sin embargo, **la volatilidad S√ç presenta autocorrelaci√≥n** (clusters), justificando el uso de modelos GARCH en cap√≠tulos posteriores.

## S√≠ntesis y Decisiones de Modelado

### Hallazgos Clave

| Aspecto | Hallazgo | Implicaci√≥n |
|---------|----------|-------------|
| **Descomposici√≥n** | Tendencia domina (>60%), estacionalidad despreciable (<5%) | Enfocarse en capturar tendencias no lineales |
| **Estacionariedad Precios** | Todas las series son I(1) (no estacionarias) | NO usar precios directamente para ARIMA |
| **Estacionariedad Retornos** | Todas las series de retornos son I(0) (estacionarias) | Modelar retornos con ARMA/GARCH |
| **Quiebres Estructurales** | COVID-19 causa cambios de r√©gimen evidentes | Considerar modelos con quiebres/cambios de r√©gimen |
| **Volatilidad** | Heterocedasticidad (volatilidad variable) | Usar modelos GARCH para capturar clusters |
| **Distribuci√≥n Retornos** | Colas pesadas (alta curtosis), asimetr√≠a negativa | Considerar distribuciones t de Student o skewed |

### Transformaciones Necesarias

```{r tabla-transformaciones, echo=FALSE}
transformaciones <- data.frame(
  Variable = c("Precios (P_t)", "Log-Precios", "Retornos (Primera Diferencia)"),
  Estacionaria = c("‚ùå No", "‚ùå No", "‚úÖ S√≠"),
  Uso_Recomendado = c(
    "Visualizaci√≥n, descomposici√≥n",
    "An√°lisis de tendencia, c√°lculo de retornos",
    "Modelado ARMA, GARCH, pron√≥stico"
  )
)

kable(transformaciones,
      col.names = c("Variable", "¬øEstacionaria?", "Uso Recomendado"),
      caption = "Resumen de transformaciones y sus aplicaciones. Los retornos (primera diferencia de log-precios) son la transformaci√≥n apropiada para modelado de series de tiempo.")
```

### Justificaci√≥n de Procedimientos

**¬øPor qu√© son necesarias estas transformaciones?**

1. **Descomposici√≥n:**
   - ‚úÖ **Necesaria:** Revela que la tendencia es el componente dominante y la estacionalidad es despreciable
   - üìä **Aplicaci√≥n:** Confirma que no necesitamos diferenciaci√≥n estacional (d=0, D=0 en SARIMA)

2. **Pruebas de Estacionariedad:**
   - ‚úÖ **Necesarias:** Confirman que los precios tienen ra√≠z unitaria y requieren diferenciaci√≥n
   - üìä **Aplicaci√≥n:** Determinan el orden de integraci√≥n (d=1 en modelos ARIMA)

3. **Transformaci√≥n Logar√≠tmica:**
   - ‚úÖ **Recomendada:** Estabiliza varianza y permite interpretar diferencias como retornos porcentuales
   - üìä **Aplicaci√≥n:** Los retornos logar√≠tmicos son est√°ndar en finanzas y tienen propiedades matem√°ticas convenientes

4. **Primera Diferenciaci√≥n:**
   - ‚úÖ **Absolutamente necesaria:** √önica transformaci√≥n que induce estacionariedad
   - üìä **Aplicaci√≥n:** Los modelos de pron√≥stico trabajar√°n con retornos, no con precios

### Pr√≥ximos Pasos

En los cap√≠tulos siguientes aplicaremos:

1. **Cap√≠tulo 3 - Modelado ARIMA:** Identificar y estimar modelos ARIMA para retornos
2. **Cap√≠tulo 4 - Modelado GARCH:** Capturar heterocedasticidad y clusters de volatilidad
3. **Cap√≠tulo 5 - Modelos de Cambio de R√©gimen:** Analizar quiebres estructurales (COVID-19)
4. **Cap√≠tulo 6 - Integraci√≥n Black-Scholes:** Usar volatilidad estimada para valoraci√≥n de opciones

**Nota:** Todos los modelos subsecuentes trabajar√°n con **retornos logar√≠tmicos estacionarios**, no con precios en niveles, garantizando validez estad√≠stica de inferencias y pron√≥sticos.
