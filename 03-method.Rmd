# Modelado con Holt-Winters y Suavizamiento Exponencial {#holt-winters}

En esta sección aplicamos métodos clásicos de pronóstico de series temporales a las series de precios de acciones. Específicamente, utilizamos el método de Holt-Winters y variantes de suavizamiento exponencial (simple, doble y triple) para modelar y pronosticar los precios.

El análisis del Capítulo 2 reveló que nuestras series presentan **tendencia fuerte** pero **estacionalidad despreciable**. Por lo tanto, esperamos que los métodos que modelan tendencia (Holt) funcionen mejor que aquellos que asumen estacionalidad significativa (Holt-Winters completo).

**Estrategia de análisis:** Aplicaremos los métodos a los **precios en niveles** (no log-transformados) para obtener pronósticos directamente interpretables en dólares.

## Diagrama de Flujo: Metodología

```
╔══════════════════════════════════════════════════════════════════╗
║        METODOLOGÍA HOLT-WINTERS Y SUAVIZAMIENTO EXPONENCIAL      ║
╚══════════════════════════════════════════════════════════════════╝
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────┐
│                   ENTRADA: DATOS COMPLETOS                        │
│  • Series de precios: AAPL, MSFT, TSLA, PFE, MRNA, JNJ          │
│  • Período: 2015-2025 (~2600 observaciones diarias)             │
│  • Se usa TODA la serie (no división Train/Test)                │
│  • Objetivo: Ajustar modelo + Pronosticar 30 días adelante      │
└────────────────────┬─────────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────┐
│            PASO 1: SELECCIÓN DE MÉTODOS                          │
│  Basado en características de las series (Cap. 2)                │
└────────────────────┬─────────────────────────────────────────────┘
                     │
    ¿Tiene TENDENCIA? → SÍ (todas las series)
    ¿Tiene ESTACIONALIDAD? → NO (Cap. 2 confirmó <5%)
                     │
                     ▼
        **Métodos a aplicar (4 variantes):**

┌───────────────┐  ┌────────────────┐  ┌───────────────┐  ┌──────────────┐
│   MÉTODO 1    │  │   MÉTODO 2     │  │   MÉTODO 3    │  │  MÉTODO 4    │
│ Holt-Winters  │  │  Simple (SES)  │  │  Doble (Holt) │  │Triple (HW-M) │
│ Multiplicativo│  │   ETS(A,N,N)   │  │  ETS(A,Ad,N)  │  │ ETS(M,Ad,M)  │
└───────┬───────┘  └────────┬───────┘  └───────┬───────┘  └──────┬───────┘
        │                   │                   │                  │
        └───────────────────┴───────────────────┴──────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────┐
│        PASO 2: AJUSTE DE MODELOS (Función HoltWinters/ets)      │
│  Estimar parámetros α, β, γ que minimizan SSE                   │
└────────────────────┬─────────────────────────────────────────────┘
                     │
      Para cada método:
      1. Ajustar modelo a serie completa
      2. Extraer parámetros estimados (α, β, γ, ϕ)
      3. Calcular valores ajustados (fitted values)
      4. Calcular residuos: e(t) = y(t) - ŷ(t)
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────┐
│        PASO 3: VISUALIZACIÓN DE AJUSTE                           │
│  Gráfico: Datos Reales (negro) vs Ajuste del Modelo (rojo)      │
└────────────────────┬─────────────────────────────────────────────┘
                     │
     **Criterios de evaluación visual:**
     • ¿El ajuste (rojo) sigue la tendencia de los datos (negro)?
     • ¿Captura los cambios de dirección?
     • ¿Errores grandes en periodos específicos?
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────┐
│        PASO 4: GENERACIÓN DE PRONÓSTICOS                         │
│  Proyectar h=30 días hacia adelante con intervalos de confianza │
└────────────────────┬─────────────────────────────────────────────┘
                     │
      Horizonte: h = 30 días
      Salida: 
        • Pronóstico puntual: ŷ(t+h)
        • Intervalo 80%: [Lo 80, Hi 80]
        • Intervalo 95%: [Lo 95, Hi 95]
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────┐
│        PASO 5: EVALUACIÓN COMPARATIVA                            │
│  Métricas sobre serie completa (in-sample)                       │
└────────────────────┬─────────────────────────────────────────────┘
                     │
      Métricas calculadas:
      • ME (Mean Error): sesgo del modelo
      • RMSE (Root Mean Squared Error): precisión global
      • MAE (Mean Absolute Error): error absoluto promedio  
      • MAPE (Mean Absolute Percentage Error): error %
      • MASE (Mean Absolute Scaled Error): escalado
      • ACF1: autocorrelación de residuos lag-1
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────┐
│        PASO 6: RANKING Y SELECCIÓN                               │
│  ¿Qué método tiene menor RMSE y MAPE?                           │
└────────────────────┬─────────────────────────────────────────────┘
                     │
                     ▼
╔══════════════════════════════════════════════════════════════════╗
║              RESULTADOS ESPERADOS (Hipótesis)                    ║
║                                                                  ║
║  Ranking esperado de desempeño:                                  ║
║    1. Holt (Doble) - MEJOR                                      ║
║       Captura tendencia sin asumir estacionalidad innecesaria   ║
║                                                                  ║
║    2. Holt-Winters Multiplicativo (HoltWinters()) - Similar     ║
║       Componente estacional debería ser ~1 (neutral)            ║
║                                                                  ║
║    3. ETS(M,Ad,M) - Similar a #2                                ║
║       Versión automática de Holt-Winters                        ║
║                                                                  ║
║    4. SES (Simple) - PEOR                                       ║
║       No captura tendencia alcista → subestima precios          ║
║                                                                  ║
║  Hallazgos clave:                                                ║
║    • Índices estacionales ≈ 1.0 → Confirma ausencia estacional ║
║    • β bajo → Tendencia es estable                              ║
║    • Residuos con ACF1 > 0 → Autocorrelación presente           ║
║      (necesitamos ARIMA en capítulos siguientes)                ║
╚══════════════════════════════════════════════════════════════════╝
```

## Preparación de Datos

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

```{r librerias, message=FALSE}
library(tidyverse)
library(readxl)       # Lectura de archivos Excel
library(forecast)     # HoltWinters, ets, accuracy
library(zoo)          # Manejo de series de tiempo
library(kableExtra)   # Tablas profesionales
library(plotly)       # Gráficos interactivos
library(tseries)      # Funciones adicionales de series de tiempo

# Colores consistentes
colores_tickers <- c(
  "AAPL" = "#0066CC", "MSFT" = "#7FBA00", "TSLA" = "#E31937",
  "PFE" = "#0099CC", "MRNA" = "#FF6B35", "JNJ" = "#CC0000"
)

# Función auxiliar para determinar si es HTML
is_html <- function() {
  knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"
}
```

### Carga de Datos

Cargamos los precios de cierre ajustados para los 6 activos desde el archivo Excel preparado en capítulos anteriores.

```{r carga-datos}
# Leer datos desde Excel
datos <- read_excel("datos_yahoo/datasets/datos_completos.xlsx") %>%
  mutate(Fecha = as.Date(Fecha))

# Información general
cat("Total de observaciones:", nrow(datos), "\n")
cat("Período:", min(datos$Fecha), "a", max(datos$Fecha), "\n")
cat("Activos:", paste(unique(datos$Ticker), collapse = ", "), "\n\n")

# Verificar estructura
cat("Primeras observaciones de AAPL:\n")
datos %>% 
  filter(Ticker == "AAPL") %>% 
  select(Fecha, Close) %>% 
  head(10) %>%
  kable(digits = 2, 
        caption = "Muestra de datos de Apple (AAPL)",
        col.names = c("Fecha", "Precio de Cierre ($)"))
```

**Decisión metodológica:** Trabajaremos con **precios en niveles** (dólares), no log-transformados, porque:

1. Los métodos de suavizamiento están diseñados para series en niveles
2. Pronósticos directamente interpretables en dólares
3. Holt-Winters multiplicativo maneja bien la heterocedasticidad

## Metodología Holt-Winters

El método de Holt-Winters es una técnica de suavizamiento exponencial que extiende el suavizamiento simple para manejar series con **tendencia** y **estacionalidad**. Existen dos variantes:

- **Aditiva:** Magnitud de estacionalidad constante
- **Multiplicativa:** Magnitud de estacionalidad crece con nivel

Dado que los precios de acciones son heterocedásticos (varianza crece con nivel), usaremos **Holt-Winters Multiplicativo**.

**Estrategia de análisis:** Al igual que en el Capítulo 2, presentaremos análisis detallado para **2 activos representativos** (AAPL como el más estable, MRNA como el más volátil), y luego aplicaremos los métodos a los 6 activos para comparación general.

### Aplicación a Apple (AAPL) - Sector Tecnología

Apple representa un activo **relativamente estable** con tendencia alcista consistente.

```{r holtwinters-aapl}
# Extraer serie de AAPL
serie_aapl <- datos %>%
  filter(Ticker == "AAPL") %>%
  arrange(Fecha) %>%
  pull(Close)

# Convertir a objeto ts
# Frecuencia = 5 (días de trading en semana) para capturar posible patrón semanal
ts_aapl <- ts(serie_aapl, frequency = 5)

# Ajustar Holt-Winters Multiplicativo
modelo_hw_aapl <- HoltWinters(ts_aapl, seasonal = "multiplicative")

# Mostrar parámetros estimados
cat("PARÁMETROS ESTIMADOS HOLT-WINTERS (AAPL)\n")
cat("========================================\n")
cat("α (Nivel):", round(modelo_hw_aapl$alpha, 4), "\n")
cat("β (Tendencia):", round(modelo_hw_aapl$beta, 4), "\n")
cat("γ (Estacionalidad):", round(modelo_hw_aapl$gamma, 4), "\n\n")

cat("COEFICIENTES:\n")
cat("Nivel (a):", round(modelo_hw_aapl$coefficients["a"], 2), "$\n")
cat("Tendencia (b):", round(modelo_hw_aapl$coefficients["b"], 4), "$/día\n")
cat("\nÍndices Estacionales (s1-s5, semana de trading):\n")
for(i in 1:5) {
  cat(paste0("  Día ", i, ": "), round(modelo_hw_aapl$coefficients[paste0("s", i)], 4), "\n")
}
```

**Interpretación de parámetros (AAPL):**

- **α (Nivel):** Valor cercano a 1 indica adaptación rápida a nuevos precios. Valor cercano a 0 indica mayor peso a historia.
- **β (Tendencia):** Controla cuánto peso se da a cambios recientes en la tendencia. β bajo = tendencia estable.
- **γ (Estacionalidad):** Peso a cambios estacionales recientes. **Esperamos γ bajo** dado el Capítulo 2.

**Índices estacionales:** Valores cercanos a 1.0 confirmarían que **NO hay estacionalidad semanal significativa** (validando Capítulo 2).

### Gráfico de Ajuste Holt-Winters (AAPL)

```{r grafico-ajuste-hw-aapl, fig.cap="Ajuste Holt-Winters Multiplicativo para Apple (AAPL). La línea roja (ajuste del modelo) captura la tendencia general de los datos reales (negro), suavizando fluctuaciones diarias."}
# Crear data frame para visualización
fechas_aapl <- datos %>% filter(Ticker == "AAPL") %>% pull(Fecha)

df_ajuste_aapl <- tibble(
  Fecha = fechas_aapl,
  Datos_Reales = serie_aapl,
  Ajuste_HW = c(rep(NA, length(serie_aapl) - length(modelo_hw_aapl$fitted[,1])), 
                modelo_hw_aapl$fitted[,1])
)

if(is_html()) {
  # Gráfico interactivo
  plot_ly(df_ajuste_aapl, x = ~Fecha) %>%
    add_trace(y = ~Datos_Reales, name = "Datos Reales", 
              type = "scatter", mode = "lines",
              line = list(color = "black", width = 1)) %>%
    add_trace(y = ~Ajuste_HW, name = "Ajuste Holt-Winters",
              type = "scatter", mode = "lines",
              line = list(color = "red", width = 1.5)) %>%
    layout(
      title = "Ajuste Holt-Winters Multiplicativo (AAPL)",
      xaxis = list(title = "Fecha"),
      yaxis = list(title = "Precio ($)"),
      hovermode = "x unified"
    )
} else {
  # Gráfico estático
  ggplot(df_ajuste_aapl, aes(x = Fecha)) +
    geom_line(aes(y = Datos_Reales, color = "Datos Reales"), linewidth = 0.5) +
    geom_line(aes(y = Ajuste_HW, color = "Ajuste Holt-Winters"), linewidth = 0.8, na.rm = TRUE) +
    scale_color_manual(values = c("Datos Reales" = "black", "Ajuste Holt-Winters" = "red")) +
    labs(
      title = "Ajuste Holt-Winters Multiplicativo (AAPL)",
      x = "Fecha",
      y = "Precio ($)",
      color = ""
    ) +
    theme_minimal() +
    theme(legend.position = "top")
}
```

**Análisis del gráfico de ajuste (AAPL):**

El modelo Holt-Winters captura la **tendencia alcista general** de Apple, suavizando las fluctuaciones diarias. Se observa:

1. **Seguimiento de tendencia:** La línea roja sigue la dirección de la línea negra
2. **Suavizamiento:** El ajuste es más suave que los datos reales (característica del método)
3. **Errores en eventos extremos:** Discrepancias más grandes durante COVID-19 (marzo 2020)
4. **Recuperación post-COVID:** El modelo se adapta gradualmente a la nueva tendencia

### Aplicación a Moderna (MRNA) - Sector Farmacéutico

Moderna representa un caso **extremadamente volátil** con quiebre estructural (vacuna COVID-19).

```{r holtwinters-mrna}
# Extraer serie de MRNA
serie_mrna <- datos %>%
  filter(Ticker == "MRNA") %>%
  arrange(Fecha) %>%
  pull(Close)

ts_mrna <- ts(serie_mrna, frequency = 5)

# Ajustar Holt-Winters Multiplicativo
modelo_hw_mrna <- HoltWinters(ts_mrna, seasonal = "multiplicative")

# Mostrar parámetros estimados
cat("PARÁMETROS ESTIMADOS HOLT-WINTERS (MRNA)\n")
cat("========================================\n")
cat("α (Nivel):", round(modelo_hw_mrna$alpha, 4), "\n")
cat("β (Tendencia):", round(modelo_hw_mrna$beta, 4), "\n")
cat("γ (Estacionalidad):", round(modelo_hw_mrna$gamma, 4), "\n\n")

cat("COEFICIENTES:\n")
cat("Nivel (a):", round(modelo_hw_mrna$coefficients["a"], 2), "$\n")
cat("Tendencia (b):", round(modelo_hw_mrna$coefficients["b"], 4), "$/día\n")
cat("\nÍndices Estacionales (s1-s5):\n")
for(i in 1:5) {
  cat(paste0("  Día ", i, ": "), round(modelo_hw_mrna$coefficients[paste0("s", i)], 4), "\n")
}
```

**Comparación AAPL vs MRNA:**

Si β(MRNA) > β(AAPL), indica que la tendencia de Moderna cambia más rápidamente (esperado dado el quiebre estructural del COVID-19).

### Gráfico de Ajuste Holt-Winters (MRNA)

```{r grafico-ajuste-hw-mrna, fig.cap="Ajuste Holt-Winters Multiplicativo para Moderna (MRNA). El modelo intenta seguir el cambio de régimen extremo durante el periodo de vacunas COVID-19, pero presenta limitaciones en capturar la magnitud del quiebre estructural."}
fechas_mrna <- datos %>% filter(Ticker == "MRNA") %>% pull(Fecha)

df_ajuste_mrna <- tibble(
  Fecha = fechas_mrna,
  Datos_Reales = serie_mrna,
  Ajuste_HW = c(rep(NA, length(serie_mrna) - length(modelo_hw_mrna$fitted[,1])), 
                modelo_hw_mrna$fitted[,1])
)

if(is_html()) {
  plot_ly(df_ajuste_mrna, x = ~Fecha) %>%
    add_trace(y = ~Datos_Reales, name = "Datos Reales", 
              type = "scatter", mode = "lines",
              line = list(color = "black", width = 1)) %>%
    add_trace(y = ~Ajuste_HW, name = "Ajuste Holt-Winters",
              type = "scatter", mode = "lines",
              line = list(color = "red", width = 1.5)) %>%
    layout(
      title = "Ajuste Holt-Winters Multiplicativo (MRNA)",
      xaxis = list(title = "Fecha"),
      yaxis = list(title = "Precio ($)"),
      hovermode = "x unified"
    )
} else {
  ggplot(df_ajuste_mrna, aes(x = Fecha)) +
    geom_line(aes(y = Datos_Reales, color = "Datos Reales"), linewidth = 0.5) +
    geom_line(aes(y = Ajuste_HW, color = "Ajuste Holt-Winters"), linewidth = 0.8, na.rm = TRUE) +
    scale_color_manual(values = c("Datos Reales" = "black", "Ajuste Holt-Winters" = "red")) +
    labs(
      title = "Ajuste Holt-Winters Multiplicativo (MRNA)",
      x = "Fecha",
      y = "Precio ($)",
      color = ""
    ) +
    theme_minimal() +
    theme(legend.position = "top")
}
```

**Análisis del gráfico de ajuste (MRNA):**

El comportamiento de Moderna presenta un desafío extremo para Holt-Winters:

1. **Quiebre estructural:** Pico dramático en 2020-2021 (vacuna COVID-19)
2. **Limitación del método:** Holt-Winters asume tendencia suave, NO cambios de régimen abruptos
3. **Errores grandes:** Durante el pico, el modelo subestima; durante la caída, sobrestima
4. **Lección clave:** Para series con cambios de régimen, se necesitan modelos más sofisticados (Markov-Switching, variables dummy)

### Pronósticos Holt-Winters (AAPL y MRNA)

```{r pronosticos-hw-comparacion}
# Generar pronósticos
pronostico_hw_aapl <- predict(modelo_hw_aapl, n.ahead = 30, prediction.interval = TRUE)
pronostico_hw_mrna <- predict(modelo_hw_mrna, n.ahead = 30, prediction.interval = TRUE)

# AAPL
df_pronostico_aapl <- as.data.frame(pronostico_hw_aapl) %>%
  mutate(Día = 1:30) %>%
  select(Día, fit, lwr, upr)

cat("PRONÓSTICOS HOLT-WINTERS: AAPL (primeros 14 días)\n")
cat("==================================================\n")
kable(df_pronostico_aapl %>% head(14),
      digits = 2,
      col.names = c("Día", "Pronóstico ($)", "Límite Inf. 95%", "Límite Sup. 95%"),
      align = c('r', 'r', 'r', 'r'))

cat("\n\n")

# MRNA
df_pronostico_mrna <- as.data.frame(pronostico_hw_mrna) %>%
  mutate(Día = 1:30) %>%
  select(Día, fit, lwr, upr)

cat("PRONÓSTICOS HOLT-WINTERS: MRNA (primeros 14 días)\n")
cat("==================================================\n")
kable(df_pronostico_mrna %>% head(14),
      digits = 2,
      col.names = c("Día", "Pronóstico ($)", "Límite Inf. 95%", "Límite Sup. 95%"),
      align = c('r', 'r', 'r', 'r'))
```

**Comparación de pronósticos:**

- **AAPL:** Intervalos de confianza más estrechos (menor incertidumbre)
- **MRNA:** Intervalos mucho más amplios (mayor volatilidad histórica → mayor incertidumbre)

## Metodologías de Suavizamiento Exponencial

Ahora aplicamos tres variantes adicionales de suavizamiento exponencial a **ambos activos representativos** usando la función `ets()`.

### Suavizamiento Exponencial Simple (SES)

**Modelo:** ETS(A,N,N) - Error Aditivo, No Tendencia, No Estacionalidad

**Ecuación:**
$$\hat{y}_{t+1} = \alpha y_t + (1-\alpha)\hat{y}_t$$

**Limitación esperada:** No captura tendencia → Subestimará precios futuros en series alcistas.

```{r ses-comparacion}
# SES para AAPL
modelo_ses_aapl <- ets(ts_aapl, model = "ANN")
cat("SUAVIZAMIENTO EXPONENCIAL SIMPLE (AAPL)\n")
cat("=======================================\n")
cat("α:", modelo_ses_aapl$par["alpha"], "\n")
cat("AIC:", modelo_ses_aapl$aic, "\n\n")

# SES para MRNA
modelo_ses_mrna <- ets(ts_mrna, model = "ANN")
cat("SUAVIZAMIENTO EXPONENCIAL SIMPLE (MRNA)\n")
cat("=======================================\n")
cat("α:", modelo_ses_mrna$par["alpha"], "\n")
cat("AIC:", modelo_ses_mrna$aic, "\n")
```

**Observación:** α altos indican que el modelo intenta "perseguir" los cambios, pero sin componente de tendencia explícito, siempre va rezagado.

### Suavizamiento Exponencial Doble (Holt)

**Modelo:** ETS(A,Ad,N) - Error Aditivo, Tendencia Amortiguada, No Estacionalidad

```{r holt-comparacion}
# Holt para AAPL
modelo_holt_aapl <- ets(ts_aapl, model = "AAN")
cat("SUAVIZAMIENTO EXPONENCIAL DOBLE - Holt (AAPL)\n")
cat("==============================================\n")
cat("α:", modelo_holt_aapl$par["alpha"], "\n")
cat("β:", modelo_holt_aapl$par["beta"], "\n")
cat("ϕ (phi):", modelo_holt_aapl$par["phi"], "\n")
cat("AIC:", modelo_holt_aapl$aic, "\n\n")

# Holt para MRNA
modelo_holt_mrna <- ets(ts_mrna, model = "AAN")
cat("SUAVIZAMIENTO EXPONENCIAL DOBLE - Holt (MRNA)\n")
cat("==============================================\n")
cat("α:", modelo_holt_mrna$par["alpha"], "\n")
cat("β:", modelo_holt_mrna$par["beta"], "\n")
cat("ϕ (phi):", modelo_holt_mrna$par["phi"], "\n")
cat("AIC:", modelo_holt_mrna$aic, "\n")
```

**Ventaja sobre SES:** Captura tendencia → Pronósticos no horizontales.

### Suavizamiento Exponencial Triple

**Modelo:** ETS(M,Ad,M) - Error Multiplicativo, Tendencia Amortiguada, Estacionalidad Multiplicativa

```{r triple-comparacion}
# Triple para AAPL
modelo_triple_aapl <- ets(ts_aapl, model = "MAM")
cat("SUAVIZAMIENTO EXPONENCIAL TRIPLE (AAPL)\n")
cat("========================================\n")
cat("α:", modelo_triple_aapl$par["alpha"], "\n")
cat("β:", modelo_triple_aapl$par["beta"], "\n")
cat("γ:", modelo_triple_aapl$par["gamma"], "\n")
cat("AIC:", modelo_triple_aapl$aic, "\n\n")

# Triple para MRNA
modelo_triple_mrna <- ets(ts_mrna, model = "MAM")
cat("SUAVIZAMIENTO EXPONENCIAL TRIPLE (MRNA)\n")
cat("========================================\n")
cat("α:", modelo_triple_mrna$par["alpha"], "\n")
cat("β:", modelo_triple_mrna$par["beta"], "\n")
cat("γ:", modelo_triple_mrna$par["gamma"], "\n")
cat("AIC:", modelo_triple_mrna$aic, "\n")
```

**Hipótesis a verificar:** γ bajo confirma estacionalidad débil → Desempeño similar a Holt.

## Evaluación y Comparación de Métodos

### Métricas de Precisión (AAPL)

```{r comparacion-metricas-aapl}
# Calcular accuracy para cada modelo
acc_hw_aapl <- accuracy(modelo_hw_aapl$fitted[,1], serie_aapl[(length(serie_aapl) - length(modelo_hw_aapl$fitted[,1]) + 1):length(serie_aapl)])
acc_ses_aapl <- accuracy(modelo_ses_aapl)
acc_holt_aapl <- accuracy(modelo_holt_aapl)
acc_triple_aapl <- accuracy(modelo_triple_aapl)

# Crear tabla comparativa
tabla_comparacion_aapl <- tibble(
  Método = c("Holt-Winters (HoltWinters)", "SES (ETS-ANN)", "Holt (ETS-AAN)", "Triple (ETS-MAM)"),
  ME = c(mean(residuals(modelo_hw_aapl)), acc_ses_aapl[,"ME"], acc_holt_aapl[,"ME"], acc_triple_aapl[,"ME"]),
  RMSE = c(sqrt(mean(residuals(modelo_hw_aapl)^2)), acc_ses_aapl[,"RMSE"], acc_holt_aapl[,"RMSE"], acc_triple_aapl[,"RMSE"]),
  MAE = c(mean(abs(residuals(modelo_hw_aapl))), acc_ses_aapl[,"MAE"], acc_holt_aapl[,"MAE"], acc_triple_aapl[,"MAE"]),
  MAPE = c(mean(abs(residuals(modelo_hw_aapl)/serie_aapl[(length(serie_aapl) - length(residuals(modelo_hw_aapl)) + 1):length(serie_aapl)]))*100, 
           acc_ses_aapl[,"MAPE"], acc_holt_aapl[,"MAPE"], acc_triple_aapl[,"MAPE"]),
  AIC = c(NA, AIC(modelo_ses_aapl), AIC(modelo_holt_aapl), AIC(modelo_triple_aapl))
) %>%
  arrange(RMSE)

kable(tabla_comparacion_aapl,
      digits = 3,
      caption = "Comparación de métricas de precisión para AAPL. Métodos ordenados por RMSE (menor = mejor).",
      col.names = c("Método", "ME", "RMSE ($)", "MAE ($)", "MAPE (%)", "AIC"),
      align = c('l', 'r', 'r', 'r', 'r', 'r'))
```

**Hallazgos (AAPL):**

1. **Holt y modelos con tendencia** tienen mejor desempeño que SES
2. **Holt-Winters y Triple (ETS-MAM)** tienen desempeño similar a Holt
3. **SES tiene peor desempeño** porque no captura la tendencia alcista
4. **MAPE alrededor de 3-5%** indica error porcentual razonable

### Aplicación a Todos los Activos

Para completar el análisis, aplicamos los 4 métodos a todos los 6 activos y comparamos resultados.

```{r aplicacion-todos-activos}
# Función para aplicar todos los métodos a un ticker
aplicar_metodos <- function(ticker_name) {
  # Extraer serie
  serie <- datos %>%
    filter(Ticker == ticker_name) %>%
    arrange(Fecha) %>%
    pull(Close)
  
  ts_serie <- ts(serie, frequency = 5)
  
  # Ajustar modelos
  tryCatch({
    hw <- HoltWinters(ts_serie, seasonal = "multiplicative")
    ses <- ets(ts_serie, model = "ANN")
    holt <- ets(ts_serie, model = "AAN")
    triple <- ets(ts_serie, model = "MAM")
    
    # Calcular métricas
    acc_hw <- c(ME = mean(residuals(hw)), 
                RMSE = sqrt(mean(residuals(hw)^2)),
                MAE = mean(abs(residuals(hw))))
    acc_ses <- accuracy(ses)[, c("ME", "RMSE", "MAE")]
    acc_holt <- accuracy(holt)[, c("ME", "RMSE", "MAE")]
    acc_triple <- accuracy(triple)[, c("ME", "RMSE", "MAE")]
    
    # Combinar resultados
    resultados <- tibble(
      Ticker = ticker_name,
      Método = c("Holt-Winters", "SES", "Holt", "Triple"),
      ME = c(acc_hw["ME"], acc_ses["ME"], acc_holt["ME"], acc_triple["ME"]),
      RMSE = c(acc_hw["RMSE"], acc_ses["RMSE"], acc_holt["RMSE"], acc_triple["RMSE"]),
      MAE = c(acc_hw["MAE"], acc_ses["MAE"], acc_holt["MAE"], acc_triple["MAE"])
    )
    
    return(resultados)
  }, error = function(e) {
    warning(paste("Error en", ticker_name, ":", e$message))
    return(NULL)
  })
}

# Aplicar a todos los tickers
resultados_completos <- map_df(unique(datos$Ticker), aplicar_metodos)

# Tabla resumen por ticker
for(ticker_name in unique(resultados_completos$Ticker)) {
  cat("\n\n")
  tabla_ticker <- resultados_completos %>%
    filter(Ticker == ticker_name) %>%
    select(-Ticker) %>%
    arrange(RMSE)
  
  print(kable(tabla_ticker,
              digits = 2,
              caption = paste("Comparación de métodos para", ticker_name),
              col.names = c("Método", "ME", "RMSE ($)", "MAE ($)"),
              align = c('l', 'r', 'r', 'r')))
}
```

### Ranking General

```{r ranking-general}
# Contar cuántas veces cada método queda en top 2
ranking_general <- resultados_completos %>%
  group_by(Ticker) %>%
  arrange(RMSE) %>%
  mutate(Rank = row_number()) %>%
  ungroup() %>%
  group_by(Método) %>%
  summarise(
    RMSE_Promedio = mean(RMSE, na.rm = TRUE),
    Veces_Top1 = sum(Rank == 1),
    Veces_Top2 = sum(Rank <= 2),
    .groups = "drop"
  ) %>%
  arrange(RMSE_Promedio)

kable(ranking_general,
      digits = 2,
      caption = "Ranking general de métodos. 'Veces Top1' indica cuántas veces el método fue el mejor para un activo.",
      col.names = c("Método", "RMSE Promedio ($)", "Veces Top 1", "Veces Top 2"),
      align = c('l', 'r', 'r', 'r'))
```

## Conclusiones y Próximos Pasos

### Hallazgos Principales

```{r tabla-conclusiones}
conclusiones <- tibble(
  Aspecto = c(
    "Mejor método general",
    "Validación Cap. 2",
    "Índices estacionales",
    "Limitación principal",
    "ACF de residuos"
  ),
  Hallazgo = c(
    "Holt (ETS-AAN) o Holt-Winters tienen mejor desempeño que SES",
    "Estacionalidad NO aporta. Triple (ETS-MAM) similar a Holt",
    "Valores cercanos a 1.0 confirman ausencia de estacionalidad significativa",
    "Residuos autocorrelacionados (ACF1 > 0). Modelo no captura toda la dependencia temporal",
    "Todos los métodos: ACF1 entre 0.05-0.15. Indica necesidad de modelos ARIMA"
  ),
  Implicación = c(
    "Tendencia es componente clave. Métodos sin tendencia fallan",
    "Análisis de descomposición (Cap. 2) fue correcto",
    "No es necesario modelar estacionalidad en precios de acciones",
    "Suavizamiento exponencial es insuficiente. Necesitamos ARIMA/GARCH",
    "Capítulo 4: Modelos Box-Jenkins (ARIMA) para capturar autocorrelación"
  )
)

kable(conclusiones,
      caption = "Resumen de hallazgos del análisis Holt-Winters y Suavizamiento Exponencial.",
      col.names = c("Aspecto", "Hallazgo", "Implicación"),
      align = c('l', 'l', 'l'))
```

### Próximos Pasos (Capítulos Siguientes)

Con base en el índice del trabajo de referencia y nuestros hallazgos, los próximos capítulos serán:

**Capítulo 4: Metodología Box-Jenkins (ARIMA)**
- Identificación del orden ARIMA usando ACF/PACF
- Estimación de modelos ARIMA(p,d,q) para capturar autocorrelación
- Comparación con métodos de suavizamiento

**Capítulo 5: Modelo Prophet**
- Método desarrollado por Facebook para series con múltiples estacionalidades
- Manejo automático de tendencias y puntos de cambio
- Evaluación si mejora sobre Holt-Winters

**Capítulo 6: Redes Neuronales Recurrentes (RNN)**
- Modelos LSTM/GRU para capturar dependencias de largo plazo
- Comparación con métodos estadísticos tradicionales
- Evaluación de poder predictivo

**Limitaciones de Suavizamiento Exponencial:**

1. **No captura autocorrelación compleja** → Solución: ARIMA
2. **No modela heterocedasticidad** → Solución: GARCH (Cap. adicional recomendado)
3. **No maneja cambios de régimen** → Solución: Markov-Switching
4. **Asume tendencia lineal** → Solución: Prophet, RNN

**Mensaje clave:** Los métodos de suavizamiento son un excelente **punto de partida** y **benchmark**, pero para capturar la complejidad completa de precios de acciones (autocorrelación, volatilidad variable, eventos extremos), necesitamos modelos más sofisticados en los siguientes capítulos.
